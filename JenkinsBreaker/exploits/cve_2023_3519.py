"""
CVE-2023-3519: Citrix NetScaler ADC/Gateway RCE

NOTE: This CVE is NOT a Jenkins vulnerability. CVE-2023-3519 is a critical remote code execution
vulnerability in Citrix NetScaler ADC and Citrix Gateway appliances. It does not directly affect
Jenkins installations.

This module is included as a stub for completeness and to document that this CVE was requested
but is not applicable to Jenkins exploitation. If Jenkins is accessed through a vulnerable
Citrix NetScaler Gateway, the gateway itself should be targeted separately.

For actual Citrix NetScaler exploitation, refer to:
- https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-201a
- https://support.citrix.com/external/article/CTX561482
"""

import requests
from rich.console import Console
from exploits import ExploitMetadata, ExploitResult

console = Console()

CVE_ID = "CVE-2023-3519"
cve = CVE_ID

METADATA = ExploitMetadata(
    cve_id=CVE_ID,
    name="Citrix NetScaler RCE (Not Jenkins)",
    description="Citrix NetScaler ADC/Gateway RCE - NOT a Jenkins vulnerability",
    affected_versions=["N/A - Not a Jenkins CVE"],
    mitre_attack=["T1190"],
    severity="critical",
    references=[
        "https://support.citrix.com/external/article/CTX561482",
        "https://nvd.nist.gov/vuln/detail/CVE-2023-3519",
        "https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-201a"
    ],
    requires_auth=False,
    requires_crumb=False,
    tags=["not-applicable", "citrix", "gateway"]
)

affected_versions = METADATA.affected_versions
mitre_attack = METADATA.mitre_attack
severity = METADATA.severity
description = METADATA.description
requires_auth = METADATA.requires_auth
requires_crumb = METADATA.requires_crumb
tags = METADATA.tags


def check_vulnerable(tool, **kwargs):
    """
    Check if Jenkins is behind a Citrix NetScaler Gateway (informational only).
    
    Args:
        tool: JenkinsBreaker instance
        **kwargs: Additional arguments
        
    Returns:
        bool: Always returns False as this is not a Jenkins vulnerability
    """
    try:
        console.print("[yellow][*] NOTE: CVE-2023-3519 is a Citrix NetScaler vulnerability, NOT Jenkins[/yellow]")
        console.print("[yellow][*] Checking if Jenkins is behind Citrix Gateway...[/yellow]")
        
        r = requests.get(
            tool.jenkins_url,
            headers=tool.custom_headers,
            proxies=tool.proxies,
            verify=False,
            timeout=10,
            allow_redirects=True
        )
        
        citrix_headers = [
            'NSC_',
            'citrix',
            'netscaler'
        ]
        
        for header_name, header_value in r.headers.items():
            header_lower = header_name.lower()
            value_lower = str(header_value).lower()
            
            if any(ch in header_lower or ch in value_lower for ch in citrix_headers):
                console.print(f"[yellow][*] Possible Citrix Gateway detected: {header_name}: {header_value}[/yellow]")
                console.print("[yellow][*] Target the Citrix Gateway separately, not Jenkins[/yellow]")
                return False
        
        console.print("[cyan][*] No Citrix Gateway detected in response headers[/cyan]")
        return False
        
    except Exception as e:
        console.print(f"[red][!] Error during check: {e}[/red]")
        return False


def run(tool, lhost=None, lport=None, **kwargs):
    """
    This is a stub implementation as CVE-2023-3519 does not apply to Jenkins.
    
    Args:
        tool: JenkinsBreaker instance
        lhost: Listener host (unused)
        lport: Listener port (unused)
        **kwargs: Additional arguments
        
    Returns:
        ExploitResult: Result indicating this CVE is not applicable
    """
    console.print(f"[yellow][*] {CVE_ID} - Citrix NetScaler RCE[/yellow]")
    console.print("[red][!] This CVE is NOT a Jenkins vulnerability[/red]")
    console.print("[cyan][*] CVE-2023-3519 affects Citrix NetScaler ADC/Gateway appliances[/cyan]")
    console.print("[cyan][*] If Jenkins is accessed through a vulnerable Citrix Gateway:[/cyan]")
    console.print("[cyan]    1. Target the Citrix Gateway directly (not Jenkins)[/cyan]")
    console.print("[cyan]    2. Use dedicated Citrix NetScaler exploitation tools[/cyan]")
    console.print("[cyan]    3. Refer to: https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-201a[/cyan]")
    
    try:
        r = requests.get(
            tool.jenkins_url,
            headers=tool.custom_headers,
            proxies=tool.proxies,
            verify=False,
            timeout=10,
            allow_redirects=True
        )
        
        citrix_detected = False
        citrix_headers_found = []
        
        citrix_indicators = ['nsc_', 'citrix', 'netscaler']
        
        for header_name, header_value in r.headers.items():
            if any(ind in header_name.lower() or ind in str(header_value).lower() for ind in citrix_indicators):
                citrix_detected = True
                citrix_headers_found.append(f"{header_name}: {header_value}")
        
        if citrix_detected:
            console.print(f"[yellow][+] Citrix Gateway detected - target gateway separately[/yellow]")
            for header in citrix_headers_found:
                console.print(f"[yellow]    {header}[/yellow]")
            
            return ExploitResult(
                exploit=CVE_ID,
                status="not_applicable",
                details="CVE-2023-3519 is a Citrix vulnerability, not Jenkins. Citrix Gateway detected - exploit gateway separately.",
                data={
                    "citrix_headers": citrix_headers_found,
                    "recommendation": "Use Citrix NetScaler exploitation tools targeting the gateway, not Jenkins"
                }
            )
        else:
            return ExploitResult(
                exploit=CVE_ID,
                status="not_applicable",
                details="CVE-2023-3519 is a Citrix NetScaler vulnerability, not a Jenkins vulnerability. No Citrix Gateway detected.",
                data={
                    "note": "This CVE does not apply to Jenkins installations"
                }
            )
    
    except Exception as e:
        return ExploitResult(
            exploit=CVE_ID,
            status="not_applicable",
            details=f"CVE-2023-3519 is not a Jenkins vulnerability. Error during detection: {str(e)}"
        )
