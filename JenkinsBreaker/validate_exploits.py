#!/usr/bin/env python3
"""
Exploit Module Validation Script

This script validates that all exploit modules conform to the standardized interface.
It checks for required attributes, methods, and metadata.
"""

import sys
import os
from rich.console import Console
from rich.table import Table
from rich.panel import Panel

sys.path.insert(0, os.path.dirname(__file__))

from exploits import ExploitRegistry, ExploitMetadata, get_mitre_description

console = Console()


def validate_module_interface(registry: ExploitRegistry, module_name: str) -> dict:
    """
    Validate that a module conforms to the exploit interface.
    
    Args:
        registry: ExploitRegistry instance
        module_name: Name of the module to validate
        
    Returns:
        dict: Validation results
    """
    results = {
        "module_name": module_name,
        "valid": True,
        "errors": [],
        "warnings": [],
        "info": {}
    }
    
    module = registry.get_module(module_name)
    if not module:
        results["valid"] = False
        results["errors"].append("Module not loaded")
        return results
    
    if not hasattr(module, 'run'):
        results["valid"] = False
        results["errors"].append("Missing required 'run' function")
    else:
        results["info"]["has_run"] = True
    
    if hasattr(module, 'CVE_ID'):
        results["info"]["cve_id"] = module.CVE_ID
    elif hasattr(module, 'cve'):
        results["info"]["cve_id"] = module.cve
        results["warnings"].append("Using legacy 'cve' instead of 'CVE_ID'")
    else:
        results["valid"] = False
        results["errors"].append("Missing CVE identifier (CVE_ID or cve)")
    
    if hasattr(module, 'METADATA'):
        metadata = module.METADATA
        if isinstance(metadata, ExploitMetadata):
            results["info"]["has_metadata"] = True
            results["info"]["metadata"] = {
                "cve_id": metadata.cve_id,
                "name": metadata.name,
                "severity": metadata.severity,
                "mitre_attack": metadata.mitre_attack,
                "affected_versions": metadata.affected_versions
            }
        else:
            results["warnings"].append("METADATA is not an ExploitMetadata instance")
    else:
        results["warnings"].append("Missing METADATA (using fallback)")
    
    if hasattr(module, 'check_vulnerable'):
        results["info"]["has_check_vulnerable"] = True
    else:
        results["warnings"].append("No check_vulnerable function (will assume vulnerable)")
    
    if hasattr(module, 'description'):
        results["info"]["has_description"] = True
    
    if hasattr(module, 'affected_versions'):
        results["info"]["has_affected_versions"] = True
    
    if hasattr(module, 'mitre_attack'):
        results["info"]["has_mitre_attack"] = True
    
    return results


def display_validation_results(results_list: list):
    """
    Display validation results in a formatted table.
    
    Args:
        results_list: List of validation result dictionaries
    """
    table = Table(title="Exploit Module Validation Results", show_header=True)
    table.add_column("Module", style="cyan")
    table.add_column("CVE ID", style="yellow")
    table.add_column("Status", style="green")
    table.add_column("Errors", style="red")
    table.add_column("Warnings", style="yellow")
    
    for results in results_list:
        status = "[+] Valid" if results["valid"] else "[-] Invalid"
        status_style = "green" if results["valid"] else "red"
        
        errors = "\n".join(results["errors"]) if results["errors"] else "-"
        warnings = "\n".join(results["warnings"]) if results["warnings"] else "-"
        cve_id = results["info"].get("cve_id", "Unknown")
        
        table.add_row(
            results["module_name"],
            cve_id,
            f"[{status_style}]{status}[/{status_style}]",
            errors,
            warnings
        )
    
    console.print(table)


def display_metadata_table(registry: ExploitRegistry):
    """
    Display detailed metadata for all loaded modules.
    
    Args:
        registry: ExploitRegistry instance
    """
    table = Table(title="Exploit Module Metadata", show_header=True)
    table.add_column("CVE ID", style="yellow")
    table.add_column("Name", style="cyan")
    table.add_column("Severity", style="red")
    table.add_column("MITRE ATT&CK", style="magenta")
    table.add_column("Affected Versions", style="blue")
    
    modules_info = registry.list_modules()
    
    for info in modules_info:
        severity_style = {
            "critical": "bold red",
            "high": "red",
            "medium": "yellow",
            "low": "green"
        }.get(info["severity"].lower(), "white")
        
        table.add_row(
            info["cve_id"],
            info["description"][:50] + "..." if len(info["description"]) > 50 else info["description"],
            f"[{severity_style}]{info['severity'].upper()}[/{severity_style}]",
            info["mitre_attack"],
            info["affected_versions"]
        )
    
    console.print(table)


def display_mitre_mapping(registry: ExploitRegistry):
    """
    Display MITRE ATT&CK technique mapping.
    
    Args:
        registry: ExploitRegistry instance
    """
    mitre_map = {}
    
    for module_name in registry._modules.keys():
        metadata = registry.get_metadata(module_name)
        if metadata and metadata.mitre_attack:
            for technique in metadata.mitre_attack:
                if technique not in mitre_map:
                    mitre_map[technique] = []
                mitre_map[technique].append(metadata.cve_id)
    
    table = Table(title="MITRE ATT&CK Technique Coverage", show_header=True)
    table.add_column("Technique ID", style="cyan")
    table.add_column("Description", style="yellow")
    table.add_column("Exploits", style="green")
    
    for technique_id in sorted(mitre_map.keys()):
        description = get_mitre_description(technique_id)
        exploits = ", ".join(mitre_map[technique_id])
        
        table.add_row(
            technique_id,
            description,
            exploits
        )
    
    console.print(table)


def main():
    """Main validation function."""
    console.print(Panel.fit(
        "[bold cyan]JenkinsBreaker Exploit Module Validation[/bold cyan]\n"
        "[yellow]Validating exploit module interface compliance[/yellow]",
        border_style="cyan"
    ))
    
    console.print("\n[cyan][*] Initializing exploit registry...[/cyan]")
    registry = ExploitRegistry()
    
    console.print("[cyan][*] Discovering modules...[/cyan]")
    discovered = registry.discover_modules()
    console.print(f"[green][+] Discovered {len(discovered)} modules: {', '.join(discovered)}[/green]\n")
    
    console.print("[cyan][*] Loading modules...[/cyan]")
    loaded_count = registry.load_all_modules()
    
    if loaded_count == 0:
        console.print("[red][!] No modules loaded successfully[/red]")
        return 1
    
    console.print(f"\n[green][+] Successfully loaded {loaded_count} modules[/green]\n")
    
    console.print("[cyan][*] Validating module interfaces...[/cyan]")
    validation_results = []
    
    for module_name in registry._modules.keys():
        results = validate_module_interface(registry, module_name)
        validation_results.append(results)
        
        if results["valid"]:
            console.print(f"[green][+] {module_name}: Valid[/green]")
        else:
            console.print(f"[red][-] {module_name}: Invalid - {', '.join(results['errors'])}[/red]")
    
    console.print("\n")
    display_validation_results(validation_results)
    
    console.print("\n")
    display_metadata_table(registry)
    
    console.print("\n")
    display_mitre_mapping(registry)
    
    all_valid = all(r["valid"] for r in validation_results)
    
    if all_valid:
        console.print("\n[bold green][+] All modules passed validation![/bold green]")
        return 0
    else:
        invalid_count = sum(1 for r in validation_results if not r["valid"])
        console.print(f"\n[bold red][-] {invalid_count} module(s) failed validation[/bold red]")
        return 1


if __name__ == "__main__":
    sys.exit(main())
