# QuantumForge Logging and Testing System

## Implementation Summary

This document describes the JSON logging system and comprehensive testing framework implemented for QuantumForge.

---

## JSON Logging System

### Overview

A unified JSON logging system (`qf_logging.h`) has been implemented for all three platform loaders:
- `quantumserver.c` (Linux)
- `quantum_loader_win.c` (Windows)
- `quantum_loader_mac.c` (macOS)

### Features

- **Cross-platform**: Works on Linux, Windows (via `%TEMP%`), and macOS (via `/tmp`)
- **JSON format**: Structured logs for easy parsing and analysis
- **Automatic log directory creation**: Creates `qf_logs/` directory automatically
- **Timestamped files**: Each run creates a unique log file with timestamp
- **Event tracking**: Records all major operations (init, decrypt, anti-analysis, execution, etc.)
- **Exit code tracking**: Records success/failure status

### Log Format

```json
{
  "platform": "linux|windows|macos",
  "timestamp": "YYYYMMDD_HHMMSS",
  "events": [
    {
      "timestamp": "YYYY-MM-DD HH:MM:SS",
      "level": "INFO|WARNING|ERROR|SUCCESS",
      "module": "module_name",
      "message": "Event description",
      "details": "Additional context (optional)"
    }
  ],
  "exit_code": 0,
  "result": "SUCCESS|FAILURE"
}
```

### Log Locations

- **Linux/macOS**: `/tmp/qf_logs/YYYYMMDD_HHMMSS_platform.json`
- **Windows**: `%TEMP%\qf_logs\YYYYMMDD_HHMMSS_platform.json`

### Logged Events

All loaders log the following events:
1. Loader initialization
2. Configuration (test mode, flags)
3. Anti-analysis checks (VM detection, debugger detection, EDR hooks)
4. Payload decryption
5. C2 trigger (DoH)
6. Beacon transmission
7. Self-delete operations
8. Payload execution
9. Exit status

### Usage in Code

```c
#include "qf_logging.h"

qf_logger_init("platform_name");
QF_LOG_INFO("module", "message", "optional_details");
QF_LOG_SUCCESS("module", "message", NULL);
QF_LOG_WARNING("module", "message", "details");
QF_LOG_ERROR("module", "error_message", "error_details");
qf_logger_close(exit_code);
```

---

## Testing Framework

### Test Scripts

#### 1. **test_loader_linux.sh** (Existing, Enhanced)
- Tests Linux loader (`quantumserver`)
- Validates EDR hook detection
- Tests self-delete functionality
- Verifies memory scrubbing
- Tests command-line flags
- Validates no disk writes

**Run:**
```bash
cd tests
./test_loader_linux.sh
```

#### 2. **test_loader_win.ps1** (New)
- Tests Windows loader (`quantum_loader_win.exe`)
- Validates command-line flag parsing
- Tests JSON logging system
- Verifies anti-analysis checks
- Tests reflective DLL loader stub
- Validates memory operations

**Run:**
```powershell
cd tests
.\test_loader_win.ps1
```

**Requirements:**
- Visual Studio (cl.exe) or MinGW (gcc.exe)
- PowerShell 5.1+

#### 3. **test_loader_mac.sh** (New)
- Tests macOS loader (`quantum_loader_mac`)
- Validates command-line flags
- Tests JSON logging
- Verifies anti-analysis (VM, debugger, timing)
- Tests Mach-O loader stub
- Validates platform frameworks (Security, Foundation)

**Run:**
```bash
cd tests
./test_loader_mac.sh
```

**Requirements:**
- macOS with Xcode command-line tools
- clang compiler

#### 4. **compile_all.sh** (New)
Unified build script that:
- Detects platform automatically
- Generates polymorphic junk code
- Compiles all platform-specific loaders
- Applies binary hardening (strip, section scrubbing)
- Outputs build summary

**Run:**
```bash
./compile_all.sh
```

**Supported Platforms:**
- Linux (native or WSL)
- macOS (native)
- Windows (via MinGW cross-compilation on Linux)

**Output Directory:**
- `build/quantumserver` (Linux)
- `build/quantum_loader_mac` (macOS)
- `build/quantum_loader_win.exe` (Windows)

#### 5. **run_tests_wsl.sh** (New)
WSL-specific test runner:
- Checks WSL environment
- Runs `compile_all.sh`
- Executes Linux loader tests
- Validates full chain

**Run from Windows:**
```batch
cd tests
test_wsl.bat
```

**Run from WSL:**
```bash
cd tests
./run_tests_wsl.sh
```

---

## Test Payloads

### Shellcode Test Payloads

Located in `tests/`:
- `test_payload.c` - Simple ELF payload (prints test message)
- `test_so.c` - Shared object test payload
- `test_dll.c` - Windows DLL test payload (requires `build_test_dll.bat`)
- `test_macho.c` - Generated by `test_loader_mac.sh`

### Building Test Payloads

**Linux:**
```bash
gcc -o test_payload test_payload.c
gcc -shared -fPIC -o test_so.so test_so.c
```

**Windows:**
```batch
cd tests
build_test_dll.bat
```

**macOS:**
```bash
clang -o test_macho test_macho.c
```

---

## WSL Testing

### Prerequisites

1. WSL2 installed with Linux distribution (Parrot, Ubuntu, etc.)
2. Access to: `\\wsl.localhost\parrot`
3. GCC, libcrypto, libssl, libcurl installed in WSL

### WSL Testing Procedure

1. **From Windows Command Prompt:**
   ```batch
   cd C:\Users\Chogyam\.zenflow\worktrees\new-task-e6e5\QuantumForge\tests
   test_wsl.bat
   ```

2. **Direct WSL Access:**
   ```bash
   wsl
   cd /mnt/c/Users/Chogyam/.zenflow/worktrees/new-task-e6e5/QuantumForge
   ./compile_all.sh
   cd tests
   ./test_loader_linux.sh
   ```

### Expected Output

All tests should pass with:
- Successful compilation
- JSON logs created in `/tmp/qf_logs/`
- No disk artifacts (except logs)
- Proper flag handling
- Anti-analysis checks executed (skipped in test mode)

---

## Verification Steps

### 1. **Compile All Loaders**
```bash
./compile_all.sh
```

**Expected:**
- 3 binaries in `build/` (depending on platform)
- No compilation errors
- Binary sizes reported
- Section scrubbing applied

### 2. **Run Platform-Specific Tests**

**Linux:**
```bash
cd tests && ./test_loader_linux.sh
```

**Windows:**
```powershell
cd tests; .\test_loader_win.ps1
```

**macOS:**
```bash
cd tests && ./test_loader_mac.sh
```

**Expected:**
- All tests pass
- JSON logs created
- Test mode output visible
- No crashes or errors

### 3. **Validate JSON Logs**

**Linux/macOS:**
```bash
ls -lh /tmp/qf_logs/
cat /tmp/qf_logs/*.json | jq .
```

**Windows:**
```powershell
Get-ChildItem $env:TEMP\qf_logs\
Get-Content $env:TEMP\qf_logs\*.json | ConvertFrom-Json
```

**Expected:**
- Valid JSON format
- Platform field matches
- Events array contains logged operations
- Exit code recorded

---

## Integration with Full Chain

### Test with Encrypted Payloads

1. **Generate Encrypted Payload:**
   ```bash
   # Linux
   ./quantum_forge.sh test_payload
   
   # Windows
   pwsh ./quantum_forge_win.ps1 -PayloadFile test.dll
   
   # macOS
   ./quantum_forge_mac.sh test_macho
   ```

2. **Run Loader:**
   ```bash
   ./quantumserver --test-mode --no-doh --no-selfdelete
   ```

3. **Check Logs:**
   ```bash
   cat /tmp/qf_logs/*.json
   ```

### Test with DoH C2

1. **Start Mock C2 Server:**
   ```bash
   cd tests
   python3 test_doh_server.py
   ```

2. **Run Loader (without --no-doh):**
   ```bash
   ./quantumserver --test-mode --no-selfdelete
   ```

3. **Verify C2 Trigger:**
   - Check logs for `"c2"` module events
   - Verify DoH query to configured provider

---

## Known Limitations

1. **Test Mode**:
   - Skips actual payload execution
   - Disables anti-analysis enforcement
   - Prevents self-delete

2. **WSL Constraints**:
   - Cannot test Windows loader in WSL (requires native Windows)
   - macOS loader requires actual macOS hardware

3. **Payload Execution**:
   - Full integration tests require:
     - Encrypted payloads (via `quantum_forge_*.sh`)
     - DoH C2 server (optional)
     - Test DLL/ELF/SO payloads

4. **Logging**:
   - Logs stored in world-readable locations (/tmp)
   - For operational use, redirect log directory or disable logging

---

## File Summary

### New Files Created

1. `qf_logging.h` - JSON logging header (cross-platform)
2. `tests/test_loader_win.ps1` - Windows test suite
3. `tests/test_loader_mac.sh` - macOS test suite
4. `compile_all.sh` - Unified build script
5. `tests/run_tests_wsl.sh` - WSL test runner
6. `tests/test_wsl.bat` - Windows batch launcher for WSL tests

### Modified Files

1. `quantumserver.c` - Added JSON logging integration
2. `quantum_loader_win.c` - Added JSON logging integration
3. `quantum_loader_mac.c` - Added JSON logging integration

---

## Next Steps

1. **Run tests in WSL**:
   ```batch
   cd tests
   test_wsl.bat
   ```

2. **Generate and test full chain**:
   - Create encrypted payloads
   - Test with DoH C2 server
   - Validate artifact-free execution

3. **Validate logs**:
   - Parse JSON logs
   - Verify all events captured
   - Check exit codes

4. **Cross-platform verification**:
   - Test on native Windows (not just WSL)
   - Test on macOS hardware if available

---

## Testing Checklist

- [x] JSON logging system implemented
- [x] Linux loader logging integrated
- [x] Windows loader logging integrated
- [x] macOS loader logging integrated
- [x] test_loader_linux.sh exists and enhanced
- [x] test_loader_win.ps1 created
- [x] test_loader_mac.sh created
- [x] compile_all.sh created
- [x] WSL test scripts created
- [ ] Full WSL testing executed
- [ ] Log files validated
- [ ] All test scripts pass

---

## Support

For issues or questions:
1. Check log files in `/tmp/qf_logs/` or `%TEMP%\qf_logs\`
2. Run tests with `--test-mode` flag for debugging
3. Verify dependencies installed (gcc, openssl, curl)
4. Check platform compatibility (Linux, Windows, macOS)
